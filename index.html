<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Ordering Portal</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for Inter font and general layout */
        body {
            font-family: 'Inter', sans-serif;
            @apply bg-gray-100 flex items-center justify-center min-h-screen p-4;
        }
        .container {
            @apply bg-white shadow-lg rounded-xl p-6 md:p-8 w-full max-w-4xl space-y-6;
        }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        /* Custom scrollbar for order list */
        .order-list-scroll {
            max-height: 400px; /* Adjust as needed */
            overflow-y: auto;
            scrollbar-width: thin; /* Firefox */
            scrollbar-color: #cbd5e0 #edf2f7; /* thumb and track track color */
        }
        .order-list-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .order-list-scroll::-webkit-scrollbar-track {
            background: #edf2f7; /* Light gray track */
            border-radius: 10px;
        }
        .order-list-scroll::-webkit-scrollbar-thumb {
            background-color: #cbd5e0; /* Medium gray thumb */
            border-radius: 10px;
            border: 2px solid #edf2f7;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-bold text-gray-800 text-center mb-6">Customer Order Portal</h1>

        <!-- Message Box -->
        <div id="messageBox" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50">
            <div class="bg-white p-6 rounded-xl shadow-lg max-w-sm w-full text-center space-y-4">
                <p id="messageText" class="text-gray-700 text-lg"></p>
                <button id="closeMessageBox" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-200">OK</button>
            </div>
        </div>

        <!-- Search Section -->
        <div class="mb-6 bg-blue-50 p-4 rounded-lg">
            <label for="partSearch" class="block text-gray-700 text-lg font-semibold mb-2">Search Part by Number/Name/Barcode:</label>
            <div class="flex flex-col sm:flex-row gap-4">
                <input type="text" id="partSearch" placeholder="e.g., ABC-123, Widget, 1234567890"
                       class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm">
                <button id="searchButton"
                        class="px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition duration-200 shadow-md">
                    Search
                </button>
            </div>
            <div id="loadingIndicator" class="hidden text-center mt-4 text-blue-600 font-medium">
                Loading products...
            </div>
            <div id="searchResults" class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Search results will be dynamically inserted here -->
            </div>
            <div id="noResults" class="hidden text-center text-gray-500 mt-4">No products found. Please try a different search term.</div>
        </div>

        <!-- Order List Section -->
        <div class="mb-6 bg-green-50 p-4 rounded-lg">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Your Order</h2>
            <div id="orderList" class="order-list-scroll border border-gray-200 rounded-lg divide-y divide-gray-200">
                <div class="p-4 text-gray-500 text-center" id="emptyOrderMessage">No items in your order yet.</div>
                <!-- Order items will be dynamically inserted here -->
            </div>
        </div>

        <!-- Customer Information and Submit Order Section -->
        <div class="bg-purple-50 p-4 rounded-lg">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Your Details</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="customerName" class="block text-gray-700 font-semibold mb-2">Your Name:</label>
                    <input type="text" id="customerName" placeholder="John Doe"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 shadow-sm">
                </div>
                <div>
                    <label for="customerEmail" class="block text-gray-700 font-semibold mb-2">Your Email:</label>
                    <input type="email" id="customerEmail" placeholder="john.doe@example.com"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 shadow-sm">
                </div>
            </div>
            <div class="mb-6">
                <label for="customerNotes" class="block text-gray-700 font-semibold mb-2">Notes (Optional):</label>
                <textarea id="customerNotes" rows="4" placeholder="Any special instructions or details for this order..."
                          class="w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 shadow-sm"></textarea>
            </div>

            <button id="submitOrder"
                    class="w-full px-6 py-4 bg-purple-600 text-white rounded-lg font-bold text-xl hover:bg-purple-700 transition duration-200 shadow-lg">
                Submit Order
            </button>
        </div>
    </div>

    <!-- EmailJS script is no longer needed on the client-side for sending -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script> -->
    <script>
        // --- CONFIGURATION (UPDATE THESE VALUES) ---
        const SHOPIFY_STORE_DOMAIN = 'dynamic.graphics'; // e.g., 'my-awesome-store.myshopify.com'
        const SHOPIFY_STOREFRONT_ACCESS_TOKEN = '4fbd7279e645a6f38c63c47650c6e49c'; // Get this from your Shopify Custom App
        
        // --- GOOGLE CLOUD FUNCTION ENDPOINT (UPDATE THIS AFTER DEPLOYMENT) ---
        const GOOGLE_CLOUD_FUNCTION_URL = 'https://send-order-email-932630472953.us-central1.run.app'; // e.g., 'https://us-central1-your-project-id.cloudfunctions.net/sendOrderEmail'

        // --- GLOBAL VARIABLES & CACHED ELEMENTS ---
        let currentOrder = []; // Stores items added to the order
        const searchInput = document.getElementById('partSearch');
        const searchButton = document.getElementById('searchButton');
        const searchResultsDiv = document.getElementById('searchResults');
        const noResultsDiv = document.getElementById('noResults');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const orderListDiv = document.getElementById('orderList');
        const emptyOrderMessage = document.getElementById('emptyOrderMessage');
        const customerNameInput = document.getElementById('customerName');
        const customerEmailInput = document.getElementById('customerEmail');
        const customerNotesInput = document.getElementById('customerNotes');
        const submitOrderButton = document.getElementById('submitOrder');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const closeMessageBoxButton = document.getElementById('closeMessageBox');

        // EmailJS initialization is no longer needed client-side
        // emailjs.init(EMAILJS_PUBLIC_KEY);

        // --- UTILITY FUNCTIONS ---

        /**
         * Displays a custom message box to the user.
         * @param {string} message The message to display.
         */
        function showMessageBox(message) {
            messageText.textContent = message;
            messageBox.classList.remove('hidden');
        }

        /**
         * Hides the custom message box.
         */
        function hideMessageBox() {
            messageBox.classList.add('hidden');
        }

        /**
         * Performs a GraphQL query to the Shopify Storefront API.
         * @param {string} query The GraphQL query string.
         * @returns {Promise<object>} The JSON response from Shopify.
         */
        async function fetchShopifyProducts(query, variables) {
            const endpoint = `https://${SHOPIFY_STORE_DOMAIN}/api/2024-07/graphql.json`; // Using a stable API version
            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Shopify-Storefront-Access-Token': SHOPIFY_STOREFRONT_ACCESS_TOKEN,
                    },
                    body: JSON.stringify({ query, variables }), // Pass variables here
                });

                if (!response.ok) {
                    const errorBody = await response.json();
                    console.error('Shopify API Error:', errorBody);
                    throw new Error(`Shopify API responded with status ${response.status}: ${JSON.stringify(errorBody)}`);
                }

                const data = await response.json();
                return data;

            } catch (error) {
                console.error('Error fetching from Shopify:', error);
                showMessageBox('Error connecting to Shopify. Please check your network or try again later.');
                return null;
            }
        }

        /**
         * Renders a single product search result item.
         * @param {object} product The Shopify product object.
         * @returns {string} HTML string for the product card.
         */
        function renderProductCard(product) {
            const imageUrl = product.featuredImage ? product.featuredImage.url : 'https://placehold.co/100x100/CCCCCC/000000?text=No+Image';
            const productTitle = product.title || 'N/A';
            // Assuming first variant's SKU, which should be available through productListings
            const productSKU = product.variants.edges.length > 0 ? product.variants.edges[0].node.sku : 'N/A'; 
            const productId = product.id; // Unique ID for the product

            return `
                <div class="flex flex-col sm:flex-row items-center bg-gray-50 border border-gray-200 rounded-lg p-4 shadow-sm">
                    <img src="${imageUrl}" alt="${productTitle}" class="w-24 h-24 object-contain rounded-lg mr-4 mb-4 sm:mb-0">
                    <div class="flex-grow text-center sm:text-left">
                        <h3 class="font-bold text-gray-800">${productTitle}</h3>
                        <p class="text-sm text-gray-600">SKU: ${productSKU}</p>
                    </div>
                    <div class="flex items-center mt-4 sm:mt-0">
                        <input type="number" value="1" min="1"
                               class="w-20 p-2 border border-gray-300 rounded-l-lg text-center quantity-input"
                               data-product-id="${productId}"
                               data-product-title="${productTitle}"
                               data-product-sku="${productSKU}"
                               data-product-image="${imageUrl}">
                        <button class="px-4 py-2 bg-blue-500 text-white rounded-r-lg hover:bg-blue-600 transition duration-200 add-to-order-btn"
                                data-product-id="${productId}">
                            Add
                        </button>
                    </div>
                </div>
            `;
        }

        /**
         * Renders the current order list.
         */
        function renderOrderList() {
            orderListDiv.innerHTML = ''; // Clear existing list
            if (currentOrder.length === 0) {
                emptyOrderMessage.classList.remove('hidden');
                orderListDiv.appendChild(emptyOrderMessage);
            } else {
                emptyOrderMessage.classList.add('hidden');
                currentOrder.forEach(item => {
                    const orderItemHtml = `
                        <div class="flex items-center justify-between p-4 bg-white hover:bg-gray-50 transition duration-150">
                            <div class="flex items-center">
                                <img src="${item.imageUrl}" alt="${item.title}" class="w-16 h-16 object-contain rounded-lg mr-4">
                                <div>
                                    <h4 class="font-semibold text-gray-800">${item.title}</h4>
                                    <p class="text-sm text-gray-600">SKU: ${item.sku} - Qty: ${item.quantity}</p>
                                </div>
                            </div>
                            <button class="px-3 py-1 bg-red-500 text-white rounded-lg hover:bg-red-600 transition duration-200 remove-from-order-btn"
                                    data-product-id="${item.id}">
                                Remove
                            </button>
                        </div>
                    `;
                    orderListDiv.insertAdjacentHTML('beforeend', orderItemHtml);
                });
            }
            attachOrderListEventListeners();
        }

        /**
         * Attaches event listeners for add/remove buttons in search results and order list.
         */
        function attachEventListeners() {
            searchButton.addEventListener('click', handleSearch);
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleSearch();
                }
            });
            submitOrderButton.addEventListener('click', handleSubmitOrder);
            closeMessageBoxButton.addEventListener('click', hideMessageBox);
        }

        /**
         * Attaches event listeners specifically for the dynamically rendered order list buttons.
         */
        function attachOrderListEventListeners() {
            document.querySelectorAll('.remove-from-order-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const productId = e.target.dataset.productId;
                    currentOrder = currentOrder.filter(item => item.id !== productId);
                    renderOrderList();
                });
            });
        }

        // --- EVENT HANDLERS ---

        /**
         * Handles the product search logic.
         */
        async function handleSearch() {
            const searchTerm = searchInput.value.trim();
            if (!searchTerm) {
                showMessageBox('Please enter a part number, name, or barcode to search.');
                return;
            }

            searchResultsDiv.innerHTML = ''; // Clear previous results
            noResultsDiv.classList.add('hidden');
            loadingIndicator.classList.remove('hidden');

            const query = `
                query ProductListingSearch($query: String!) {
                    productListings(first: 10, query: $query) {
                        edges {
                            node {
                                id
                                title
                                featuredImage {
                                    url
                                }
                                variants(first: 1) {
                                    edges {
                                        node {
                                            sku
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            `;

            const variables = { query: searchTerm };
            const data = await fetchShopifyProducts(query, variables);

            loadingIndicator.classList.add('hidden');

            if (data && data.data && data.data.productListings && data.data.productListings.edges.length > 0) {
                data.data.productListings.edges.forEach(edge => {
                    const product = edge.node;
                    searchResultsDiv.insertAdjacentHTML('beforeend', renderProductCard(product));
                });
                // Attach event listeners to newly rendered 'Add' buttons
                document.querySelectorAll('.add-to-order-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const productId = e.target.dataset.productId;
                        const quantityInput = document.querySelector(`.quantity-input[data-product-id="${productId}"]`);
                        const quantity = parseInt(quantityInput.value, 10);

                        if (isNaN(quantity) || quantity <= 0) {
                            showMessageBox('Please enter a valid quantity (1 or more).');
                            return;
                        }

                        const productTitle = quantityInput.dataset.productTitle;
                        const productSku = quantityInput.dataset.productSku;
                        const productImage = quantityInput.dataset.productImage;

                        const existingItemIndex = currentOrder.findIndex(item => item.id === productId);

                        if (existingItemIndex > -1) {
                            currentOrder[existingItemIndex].quantity += quantity;
                        } else {
                            currentOrder.push({
                                id: productId,
                                title: productTitle,
                                sku: productSku,
                                imageUrl: productImage,
                                quantity: quantity
                            });
                        }
                        renderOrderList();
                        showMessageBox(`${quantity} x ${productTitle} added to order!`);
                    });
                });
            } else {
                noResultsDiv.classList.remove('hidden');
            }
        }

        /**
         * Handles the order submission. Sends order data to a Google Cloud Function.
         */
        async function handleSubmitOrder() {
            const customerName = customerNameInput.value.trim();
            const customerEmail = customerEmailInput.value.trim();
            const customerNotes = customerNotesInput.value.trim();

            if (currentOrder.length === 0) {
                showMessageBox('Your order is empty. Please add some items before submitting.');
                return;
            }

            if (!customerName || !customerEmail) {
                showMessageBox('Please enter your Name and Email to submit the order.');
                return;
            }

            // Prepare payload for the Google Cloud Function
            const orderPayload = {
                customer_name: customerName,
                customer_email: customerEmail,
                customer_notes: customerNotes,
                order_details: currentOrder.map(item => ({
                    id: item.id,
                    title: item.title,
                    sku: item.sku,
                    quantity: item.quantity,
                    imageUrl: item.imageUrl
                }))
            };

            submitOrderButton.textContent = 'Submitting...';
            submitOrderButton.disabled = true;

            try {
                const response = await fetch(GOOGLE_CLOUD_FUNCTION_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(orderPayload),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Cloud Function Error:', errorData);
                    throw new Error(`Cloud Function responded with status ${response.status}: ${errorData.message || 'Unknown error'}`);
                }

                showMessageBox('Order submitted successfully! You will receive a confirmation email shortly.');
                // Clear the form and order
                currentOrder = [];
                renderOrderList();
                searchInput.value = '';
                searchResultsDiv.innerHTML = '';
                customerNameInput.value = '';
                customerEmailInput.value = '';
                customerNotesInput.value = '';
            } catch (error) {
                console.error('Failed to submit order:', error);
                showMessageBox('Failed to submit order. Please try again or contact support.');
            } finally {
                submitOrderButton.textContent = 'Submit Order';
                submitOrderButton.disabled = false;
            }
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            attachEventListeners();
            renderOrderList(); // Render empty order list on load
        });
    </script>
</body>
</html>

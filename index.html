<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

    // --- GLOBAL FIREBASE VARIABLES ---
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    const firebaseConfig = {
        apiKey: "AIzaSyBdp15BtxFu-VPkuOdkiX1WyXgAMLrj124",
        authDomain: "cg-portal-backend.firebaseapp.com",
        projectId: "cg-portal-backend",
        storageBucket: "cg-portal-backend.firebasestorage.app",
        messagingSenderId: "543604960285",
        appId: "1:543604960285:web:03b481d610a5eb2fdcaaf4",
    };

    // --- CONFIGURATION ---
    const EMAILJS_SERVICE_ID = 'service_6r03vij';
    const EMAILJS_TEMPLATE_ID_CUSTOMER = 'template_0kb0906';
    const EMAILJS_TEMPLATE_ID_ADMIN = 'template_zal2biw';
    const EMAILJS_USER_ID = 'LWqR9FL0EyxzFU7jm';
    const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRJeafxZBqtfXhW91V849PmPbr1C0ExZmnvfQ_410tdo4PPDvXNPHC44VrBEd3G7nRpPulT-XC6R79X/pub?gid=1341072506&single=true&output=csv';
    const ENVELOPE_SKU = 'CG-SE1';

    // --- GLOBAL VARIABLES & CACHED ELEMENTS ---
    let currentOrder = [];
    let productCatalog = [];

    const searchInput = document.getElementById('partSearch');
    const searchButton = document.getElementById('searchButton');
    const searchResultsDiv = document.getElementById('searchResults');
    const noResultsDiv = document.getElementById('noResults');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const orderListDiv = document.getElementById('orderList');
    const emptyOrderMessage = document.getElementById('emptyOrderMessage');
    const customerNameInput = document.getElementById('customerName');
    const customerEmailInput = document.getElementById('customerEmail');
    const customerNotesInput = document.getElementById('customerNotes');
    const submitOrderButton = document.getElementById('submitOrder');
    const messageBox = document.getElementById('messageBox');
    const messageText = document.getElementById('messageText');
    const closeMessageBoxButton = document.getElementById('closeMessageBox');

    const authOverlay = document.getElementById('authOverlay');
    const authTitle = document.getElementById('authTitle');
    const authNameInput = document.getElementById('authName');
    const authEmailInput = document.getElementById('authEmail');
    const authPasswordInput = document.getElementById('authPassword');
    const authSubmitButton = document.getElementById('authSubmit');
    const authError = document.getElementById('authError');
    const toggleAuthMode = document.getElementById('toggleAuthMode');
    const toggleAuthModeText = document.getElementById('toggleAuthModeText');
    const mainContainer = document.querySelector('.container');

    const orderTotalsSummaryDiv = document.getElementById('orderTotalsSummary');
    const totalNonGlowSpan = document.getElementById('totalNonGlow');
    const totalGlowSpan = document.getElementById('totalGlow');
    const totalEnvelopeSpan = document.getElementById('totalEnvelope');

    const userIdDisplay = document.getElementById('userIdDisplay');
    const currentUserNameSpan = document.getElementById('currentUserName');
    const logoutButton = document.getElementById('logoutButton');

    const orderHistoryListDesktop = document.getElementById('orderHistoryListDesktop');
    const emptyOrderHistoryMessageDesktop = document.getElementById('emptyOrderHistoryMessageDesktop');
    const orderHistoryListMobile = document.getElementById('orderHistoryListMobile');
    const emptyOrderHistoryMessageMobile = document.getElementById('emptyOrderHistoryMessageMobile');

    const floatingOrderHistoryBtn = document.getElementById('floatingOrderHistoryBtn');
    const orderHistoryModal = document.getElementById('orderHistoryModal');
    const orderHistoryModalCloseBtn = document.getElementById('orderHistoryModalCloseBtn');

    const generateProofBtn = document.getElementById('generateProofBtn');
    const proofModal = document.getElementById('proofModal');
    const closeProofModal = document.getElementById('closeProofModal');
    const proofContent = document.getElementById('proofContent');
    const approveProofBtn = document.getElementById('approveProofBtn');
    const reviseOrderBtn = document.getElementById('reviseOrderBtn');

    const customFileUploadInput = document.getElementById('customFileUpload');
    const uploadCustomFileBtn = document.getElementById('uploadCustomFileBtn');
    const customUploadList = document.getElementById('customUploadList');

    let isLoginMode = true;
    let app, db, auth, storage;
    let currentUserId = null;
    let currentUserEmail = null;
    let currentUserName = null;

    // --- UTILITY FUNCTIONS ---

    function parseCSV(csvText) {
        console.log('Parsing CSV Text (raw):', csvText);
        const lines = csvText.trim().split(/\r?\n/);
        if (lines.length === 0) {
            console.warn('No lines found in CSV text.');
            return [];
        }
        console.log('Raw CSV Header Line:', lines[0]);
        const csvSplitRegex = /,(?=(?:(?:[^"]*"){2})*[^"]*$)/;
        const rawHeaders = lines[0].split(csvSplitRegex);
        console.log('Headers after initial split (raw values):', rawHeaders);
        const headers = rawHeaders.map(header => header.trim().replace(/^"|"$/g, '')).filter(header => header !== '');
        console.log('Final Parsed Headers:', headers);
        if (headers.length === 0) {
            console.error('ERROR: No valid headers found.');
            showMessageBox('Error: Product catalog headers are malformed or missing.');
            return [];
        }
        const data = [];
        for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (line === '') {
                console.log(`Skipping empty line ${i + 1}.`);
                continue;
            }
            const values = line.split(csvSplitRegex).map(value => value.trim().replace(/^"|"$/g, ''));
            if (values.length > headers.length) {
                console.warn(`Skipping row ${i + 1} due to column mismatch. Expected ${headers.length}, got ${values.length}. Row: "${line}"`);
                values.length = headers.length;
            } else if (values.length < headers.length) {
                console.warn(`Skipping row ${i + 1} due to column mismatch. Expected ${headers.length}, got ${values.length}. Row: "${line}"`);
                continue;
            }
            const rowObject = {};
            headers.forEach((header, index) => {
                if (header === 'searchTerms') {
                    rowObject[header] = values[index].split(',').map(term => term.trim().toLowerCase()).filter(term => term !== '');
                } else {
                    rowObject[header] = values[index];
                }
            });
            data.push(rowObject);
        }
        console.log('Parsed Data:', data);
        return data;
    }

    async function fetchProductCatalog() {
        try {
            loadingIndicator.textContent = 'Loading product catalog...';
            loadingIndicator.classList.remove('hidden');
            console.log('Fetching product catalog from:', GOOGLE_SHEET_CSV_URL);
            const response = await fetch(GOOGLE_SHEET_CSV_URL);
            if (!response.ok) {
                throw new Error(`Failed to fetch product catalog: ${response.statusText}`);
            }
            const csvText = await response.text();
            console.log('Raw CSV Text:', csvText.substring(0, 200) + '...');
            productCatalog = parseCSV(csvText);
            const envelopeItem = {
                id: 'CG-SE1',
                title: 'Custom Sticker Envelopes',
                sku: 'CG-SE1',
                imageUrl: 'https://storage.googleapis.com/cg-portal-assets/CG-SE1%20White%20Bubble%20Sticker%20Envelope.png',
                searchTerms: ['envelope', 'envelopes', 'cg-se1']
            };
            if (!productCatalog.some(item => item.id === envelopeItem.id)) {
                productCatalog.push(envelopeItem);
            }
            console.log('Final Product Catalog:', productCatalog);
            loadingIndicator.classList.add('hidden');
        } catch (error) {
            console.error('Error fetching product catalog:', error);
            loadingIndicator.classList.add('hidden');
            showMessageBox('Error loading product catalog. Please try refreshing or contact support.');
        }
    }

    function showMessageBox(message) {
        messageText.textContent = message;
        messageBox.classList.remove('hidden');
    }

    function hideMessageBox() {
        messageBox.classList.add('hidden');
    }

    function renderProductCard(product) {
        const productId = product.id || `unknown-id-${Math.random().toString(36).substring(7)}`;
        const uniqueId = productId.replace(/[^a-zA-Z0-9-_]/g, '');
        const initialQuantity = (product.sku === ENVELOPE_SKU) ? 1 : 100;
        const minQuantity = (product.sku === ENVELOPE_SKU) ? 1 : 1;
        const quantityUnit = (product.sku === ENVELOPE_SKU) ? ' (x1000)' : '';
        return `
            <div class="w-full sm:w-56 lg:w-64 flex flex-col items-center bg-gray-50 border border-gray-200 rounded-lg p-4 shadow-sm text-center">
                <img src="${product.imageUrl}" alt="${product.title}" class="w-20 h-20 object-contain rounded-lg mb-4 flex-shrink-0" onerror="this.onerror=null;this.src='https://placehold.co/100x100/CCCCCC/000000?text=No+Image';">
                <div class="flex-grow w-full">
                    <h3 class="font-bold text-gray-800 break-words">${product.title}</h3>
                    <p class="text-sm text-gray-600">SKU: ${product.sku}</p>
                </div>
                <div class="flex flex-col items-center mt-4 w-full gap-2">
                    <input type="number" value="${initialQuantity}" min="${minQuantity}"
                           class="w-full p-2 border border-gray-300 rounded-lg text-center quantity-input"
                           id="qty-${uniqueId}"
                           data-product-id="${productId}"
                           data-product-title="${product.title}"
                           data-product-sku="${product.sku}"
                           data-product-image="${product.imageUrl}">
                    <button class="w-full px-3 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition duration-200 add-to-order-btn"
                            data-product-id="${productId}">
                        Add${quantityUnit}
                    </button>
                </div>
            </div>
        `;
    }

    function renderOrderList() {
        orderListDiv.innerHTML = '';
        if (currentOrder.length === 0) {
            emptyOrderMessage.classList.remove('hidden');
            orderListDiv.appendChild(emptyOrderMessage);
            orderTotalsSummaryDiv.classList.add('hidden');
        } else {
            emptyOrderMessage.classList.add('hidden');
            currentOrder.forEach(item => {
                const quantityDisplay = (item.sku === ENVELOPE_SKU) ? `${item.quantity} (in 1,000s)` : item.quantity;
                const packingDetailsDisplay = item.packing_details ? `<br><span class="text-xs text-gray-500">Packing: ${item.packing_details}</span>` : '';
                const orderItemHtml = `
                    <div class="flex items-center justify-between p-4 bg-white hover:bg-gray-50 transition duration-150">
                        <div class="flex items-center">
                            <img src="${item.imageUrl}" alt="${item.title}" class="w-16 h-16 object-contain rounded-lg mr-4" onerror="this.onerror=null;this.src='https://placehold.co/40x40/CCCCCC/000000?text=No+Image';">
                            <div class="min-w-0">
                                <h4 class="font-semibold text-gray-800 break-words w-full">${item.title}</h4>
                                <p class="text-sm text-gray-600">SKU: ${item.sku} - Qty: ${quantityDisplay}${packingDetailsDisplay}</p>
                            </div>
                        </div>
                        <button class="px-3 py-1 bg-red-500 text-white rounded-lg hover:bg-red-600 transition duration-200 remove-from-order-btn"
                                data-product-id="${item.id}">
                            Remove
                        </button>
                    </div>
                `;
                orderListDiv.insertAdjacentHTML('beforeend', orderItemHtml);
            });
            updateOrderTotals();
            orderTotalsSummaryDiv.classList.remove('hidden');
        }
        attachOrderListEventListeners();
    }

    function updateOrderTotals() {
        let totalQuantityNonGlow = 0;
        let totalQuantityGlow = 0;
        let totalQuantityEnvelope = 0;
        currentOrder.forEach(item => {
            if (item.sku === ENVELOPE_SKU) {
                totalQuantityEnvelope += item.quantity;
            } else if (item.title.toLowerCase().includes('glow in the dark') || item.sku.toLowerCase().includes('glow in the dark') || item.sku.toLowerCase().includes('gitd')) {
                totalQuantityGlow += item.quantity;
            } else {
                totalQuantityNonGlow += item.quantity;
            }
        });
        totalNonGlowSpan.textContent = new Intl.NumberFormat('en-US').format(totalQuantityNonGlow);
        totalGlowSpan.textContent = new Intl.NumberFormat('en-US').format(totalQuantityGlow);
        totalEnvelopeSpan.textContent = new Intl.NumberFormat('en-US').format(totalQuantityEnvelope * 1000);
    }

    function renderOrderHistory(orders) {
        orderHistoryListDesktop.innerHTML = '';
        if (orders.length === 0) {
            emptyOrderHistoryMessageDesktop.classList.remove('hidden');
            orderHistoryListDesktop.appendChild(emptyOrderHistoryMessageDesktop);
        } else {
            emptyOrderHistoryMessageDesktop.classList.add('hidden');
            orders.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));
            orders.forEach(order => {
                const orderHtml = createOrderHistoryCardHtml(order);
                orderHistoryListDesktop.insertAdjacentHTML('beforeend', orderHtml);
            });
        }
        orderHistoryListMobile.innerHTML = '';
        if (orders.length === 0) {
            emptyOrderHistoryMessageMobile.classList.remove('hidden');
            orderHistoryListMobile.appendChild(emptyOrderHistoryMessageMobile);
        } else {
            emptyOrderHistoryMessageMobile.classList.add('hidden');
            orders.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));
            orders.forEach(order => {
                const orderHtml = createOrderHistoryCardHtml(order);
                orderHistoryListMobile.insertAdjacentHTML('beforeend', orderHtml);
            });
        }
        attachOrderHistoryEventListeners(orders);
    }

    function createOrderHistoryCardHtml(order) {
        const orderDate = order.timestamp ? new Date(order.timestamp.toDate()).toLocaleString() : 'N/A';
        return `
            <div class="order-history-card" data-order-id="${order.id}">
                <button class="order-history-header" data-order-id="${order.id}">
                    <h4 class="font-bold">${orderDate}</h4>
                    <span class="toggle-details-btn" data-order-id="${order.id}">
                        View Details
                    </span>
                </button>
                <div id="order-details-${order.id}" class="order-history-details hidden">
                    <p class="text-sm text-gray-600 mb-2">Ordered by: ${order.customer_name} (${order.customer_email})</p>
                    ${order.customer_notes ? `<p class="text-sm text-gray-600 mb-2">Notes: ${order.customer_notes}</p>` : ''}
                    <div class="ml-4">
                        ${order.order_details.map(item => {
                            const quantityDisplay = (item.sku === ENVELOPE_SKU) ? `${item.quantity} (in 1,000s)` : item.quantity;
                            const packingDetailsDisplay = item.packing_details ? `<br><span class="text-xs text-gray-500">Packing: ${item.packing_details}</span>` : '';
                            return `
                                <div class="flex items-center mb-2">
                                    <img src="${item.imageUrl}" alt="${item.title}" class="w-10 h-10 object-contain rounded-md mr-2" onerror="this.onerror=null;this.src='https://placehold.co/40x40/CCCCCC/000000?text=No+Image';">
                                    <p class="text-sm text-gray-700">${item.title} (SKU: ${item.sku}) - Qty: ${quantityDisplay}${packingDetailsDisplay}</p>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <button class="reorder-btn" data-order-id="${order.id}">Re-order This</button>
                </div>
            </div>
        `;
    }

    function toggleOrderDetails(orderId) {
        const detailsDivDesktop = document.querySelector(`#orderHistoryListDesktop #order-details-${orderId}`);
        const detailsDivMobile = document.querySelector(`#orderHistoryListMobile #order-details-${orderId}`);
        if (detailsDivDesktop) {
            detailsDivDesktop.classList.toggle('hidden');
            const toggleButton = document.querySelector(`#orderHistoryListDesktop .order-history-header[data-order-id="${orderId}"] .toggle-details-btn`);
            if (toggleButton) {
                toggleButton.textContent = detailsDivDesktop.classList.contains('hidden') ? 'View Details' : 'Hide Details';
            }
        }
        if (detailsDivMobile) {
            detailsDivMobile.classList.toggle('hidden');
            const toggleButton = document.querySelector(`#orderHistoryListMobile .order-history-header[data-order-id="${orderId}"] .toggle-details-btn`);
            if (toggleButton) {
                toggleButton.textContent = detailsDivMobile.classList.contains('hidden') ? 'View Details' : 'Hide Details';
            }
        }
    }

    function handleReorder(orderId) {
        const orderToReorder = window.orderHistoryList.find(order => order.id === orderId);
        if (orderToReorder) {
            currentOrder = JSON.parse(JSON.stringify(orderToReorder.order_details));
            renderOrderList();
            showMessageBox('Order items from history have been added to your current order!');
            orderHistoryModal.classList.add('hidden');
        } else {
            showMessageBox('Could not find this order in history to re-order.');
        }
    }

    function attachEventListeners() {
        searchButton.addEventListener('click', handleSearch);
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleSearch();
            }
        });
        messageBox.addEventListener('click', (e) => {
            if (e.target === messageBox) {
                hideMessageBox();
            }
        });
        closeMessageBoxButton.addEventListener('click', hideMessageBox);
        authSubmitButton.addEventListener('click', handleAuthSubmit);
        authNameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                authEmailInput.focus();
            }
        });
        authEmailInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                authPasswordInput.focus();
            }
        });
        authPasswordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleAuthSubmit();
            }
        });
        toggleAuthMode.addEventListener('click', toggleAuthForm);
        logoutButton.addEventListener('click', handleLogout);
        floatingOrderHistoryBtn.addEventListener('click', () => {
            orderHistoryModal.classList.remove('hidden');
        });
        orderHistoryModalCloseBtn.addEventListener('click', () => {
            orderHistoryModal.classList.add('hidden');
        });
        orderHistoryModal.addEventListener('click', (e) => {
            if (e.target === orderHistoryModal) {
                orderHistoryModal.classList.add('hidden');
            }
        });
        generateProofBtn.addEventListener('click', generateProofAndShowModal);
        closeProofModal.addEventListener('click', () => proofModal.classList.add('hidden'));
        approveProofBtn.addEventListener('click', handleSubmitOrder);
        reviseOrderBtn.addEventListener('click', () => proofModal.classList.add('hidden'));
        proofModal.addEventListener('click', (e) => {
            if (e.target === proofModal) {
                proofModal.classList.add('hidden');
            }
        });
        uploadCustomFileBtn.addEventListener('click', handleFileUpload);
    }

    function attachOrderListEventListeners() {
        document.querySelectorAll('.remove-from-order-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const productId = e.target.dataset.productId;
                currentOrder = currentOrder.filter(item => item.id !== productId);
                renderOrderList();
            });
        });
    }

    function attachOrderHistoryEventListeners(orders) {
        window.orderHistoryList = orders;
        document.querySelectorAll('.order-history-header').forEach(button => {
            button.addEventListener('click', (e) => {
                if (!e.target.classList.contains('reorder-btn')) {
                    const orderId = e.currentTarget.dataset.orderId;
                    toggleOrderDetails(orderId);
                }
            });
        });
        document.querySelectorAll('.reorder-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const orderId = e.target.dataset.orderId;
                handleReorder(orderId);
            });
        });
    }

    // --- AUTHENTICATION LOGIC ---

    function toggleAuthForm() {
        isLoginMode = !isLoginMode;
        authError.classList.add('hidden');
        authNameInput.value = '';
        authEmailInput.value = '';
        authPasswordInput.value = '';
        if (isLoginMode) {
            authTitle.textContent = 'Login to Access Portal';
            authNameInput.classList.add('hidden');
            authNameInput.style.display = 'none';
            authSubmitButton.textContent = 'Login';
            toggleAuthModeText.textContent = "Don't have an account?";
            toggleAuthMode.textContent = 'Sign Up';
            authEmailInput.autocomplete = 'email';
            authPasswordInput.autocomplete = 'current-password';
        } else {
            authTitle.textContent = 'Sign Up for Portal Access';
            authNameInput.classList.remove('hidden');
            authNameInput.style.display = 'block';
            authSubmitButton.textContent = 'Sign Up';
            toggleAuthModeText.textContent = "Already have an account?";
            toggleAuthMode.textContent = 'Login';
            authEmailInput.autocomplete = 'new-password';
            authPasswordInput.autocomplete = 'new-password';
        }
    }

    async function handleAuthSubmit() {
        const name = authNameInput.value.trim();
        const email = authEmailInput.value.trim();
        const password = authPasswordInput.value.trim();
        if (!email || !password) {
            authError.textContent = 'Please enter both email and password.';
            authError.classList.remove('hidden');
            return;
        }
        if (!isLoginMode && !name) {
            authError.textContent = 'Please enter your name.';
            authError.classList.remove('hidden');
            return;
        }
        authSubmitButton.disabled = true;
        authError.classList.add('hidden');
        try {
            if (isLoginMode) {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                await setDoc(doc(db, `artifacts/${appId}/users_profile`, user.uid), {
                    name: user.displayName || email,
                    email: email,
                }, { merge: true });
            } else {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                await setDoc(doc(db, `artifacts/${appId}/users_profile`, user.uid), {
                    name: name,
                    email: email,
                    createdAt: serverTimestamp()
                });
            }
            console.log("Authentication successful, user is now logged in.");
            authOverlay.style.display = 'none';
            authOverlay.classList.add('hidden');
            mainContainer.style.display = 'flex';
            mainContainer.classList.remove('hidden');
            fetchProductCatalog();
        } catch (error) {
            let errorMessage = 'An unknown error occurred.';
            switch (error.code) {
                case 'auth/invalid-email':
                    errorMessage = 'Invalid email address format.';
                    break;
                case 'auth/user-disabled':
                    errorMessage = 'Your account has been disabled.';
                    break;
                case 'auth/user-not-found':
                case 'auth/wrong-password':
                    errorMessage = 'Incorrect email or password.';
                    break;
                case 'auth/email-already-in-use':
                    errorMessage = 'This email is already registered. Try logging in.';
                    break;
                case 'auth/weak-password':
                    errorMessage = 'Password is too weak. Please use at least 6 characters.';
                    break;
                default:
                    console.error('Firebase Auth Error:', error);
                    errorMessage = `Authentication failed: ${error.message}`;
            }
            authError.textContent = errorMessage;
            authError.classList.remove('hidden');
        } finally {
            authSubmitButton.disabled = false;
        }
    }

    async function handleLogout() {
        try {
            await signOut(auth);
            showMessageBox('You have been logged out.');
        } catch (error) {
            console.error('Error logging out:', error);
            showMessageBox('Failed to log out. Please try again.');
        }
    }

    // --- EVENT HANDLERS ---

    async function handleSearch() {
        const searchTerm = searchInput.value.trim().toLowerCase();
        searchResultsDiv.innerHTML = '';
        noResultsDiv.classList.add('hidden');
        loadingIndicator.textContent = 'Searching...';
        loadingIndicator.classList.remove('hidden');
        if (!searchTerm) {
            loadingIndicator.classList.add('hidden');
            showMessageBox('Please enter a part number, name, or barcode to search.');
            return;
        }
        await new Promise(resolve => setTimeout(resolve, 300));
        const filteredProducts = productCatalog.filter(product =>
            (product.searchTerms && Array.isArray(product.searchTerms) && product.searchTerms.some(term => term.includes(searchTerm))) ||
            (product.title && typeof product.title === 'string' && product.title.toLowerCase().includes(searchTerm)) ||
            (product.sku && typeof product.sku === 'string' && product.sku.toLowerCase().includes(searchTerm))
        );
        console.log('Filtered Products:', filteredProducts);
        loadingIndicator.classList.add('hidden');
        if (filteredProducts.length > 0) {
            filteredProducts.forEach(product => {
                searchResultsDiv.insertAdjacentHTML('beforeend', renderProductCard(product));
            });
            document.querySelectorAll('.add-to-order-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const productId = e.target.dataset.productId;
                    const productToAdd = productCatalog.find(p => p.id === productId);
                    if (!productToAdd) {
                        console.error('Product not found:', productId);
                        showMessageBox('Error: Product not found. Please try searching again.');
                        return;
                    }
                    const uniqueInputId = `qty-${productId.replace(/[^a-zA-Z0-9-_]/g, '')}`;
                    const quantityInput = document.getElementById(uniqueInputId);
                    const quantity = parseInt(quantityInput.value, 10);
                    if (isNaN(quantity) || quantity <= 0) {
                        showMessageBox('Please enter a valid quantity (1 or more).');
                        return;
                    }
                    const existingItemIndex = currentOrder.findIndex(item => item.id === productId);
                    if (existingItemIndex > -1) {
                        currentOrder[existingItemIndex].quantity += quantity;
                    } else {
                        currentOrder.unshift({
                            id: productToAdd.id,
                            title: productToAdd.title || '',
                            sku: productToAdd.sku || '',
                            imageUrl: productToAdd.imageUrl || 'https://placehold.co/40x40/CCCCCC/000000?text=No+Image',
                            quantity: quantity || 0
                        });
                    }
                    renderOrderList();
                });
            });
        } else {
            noResultsDiv.classList.remove('hidden');
        }
    }

    async function handleFileUpload() {
        if (!currentUserId) {
            showMessageBox('Please log in to upload custom designs.');
            return;
        }
        const files = customFileUploadInput.files;
        if (files.length === 0) {
            showMessageBox('Please select one or more PNG files to upload.');
            return;
        }
        customUploadList.innerHTML = '';
        for (const file of files) {
            if (file.type !== 'image/png') {
                showMessageBox(`Skipping "${file.name}": Only PNG files are allowed.`);
                continue;
            }
            if (file.size > 5 * 1024 * 1024) {
                showMessageBox(`Skipping "${file.name}": File size exceeds 5MB limit.`);
                continue;
            }
            const uploadItemId = `upload-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`;
            const fileNameWithoutExt = file.name.split('.').slice(0, -1).join('.');
            const uploadItemDiv = document.createElement('div');
            uploadItemDiv.id = uploadItemId;
            uploadItemDiv.className = 'flex items-center justify-between p-2 border border-gray-200 rounded-md bg-white shadow-sm';
            uploadItemDiv.innerHTML = `
                <div class="flex items-center">
                    <img src="https://placehold.co/40x40/CCCCCC/000000?text=..." alt="Loading" class="w-10 h-10 object-contain rounded-md mr-2">
                    <div>
                        <p class="font-semibold text-gray-800">${fileNameWithoutExt}</p>
                        <p class="text-xs text-gray-500" id="${uploadItemId}-status">Uploading...</p>
                    </div>
                </div>
            `;
            customUploadList.appendChild(uploadItemDiv);
            try {
                const storagePath = `artifacts/${appId}/user_uploads/${currentUserId}/${Date.now()}-${file.name}`;
                const fileRef = ref(storage, storagePath);
                const snapshot = await uploadBytes(fileRef, file);
                const downloadURL = await getDownloadURL(snapshot.ref);
                const uploadedItem = {
                    id: uploadItemId,
                    title: fileNameWithoutExt,
                    sku: 'CUSTOM_UPLOAD',
                    quantity: 2000,
                    imageUrl: downloadURL,
                    packing_details: '1500 in bags of 5, 500 bulk in 100s'
                };
                currentOrder.unshift(uploadedItem);
                renderOrderList();
                const statusElem = document.getElementById(`${uploadItemId}-status`);
                if (statusElem) {
                    statusElem.textContent = 'Upload complete! Added to order.';
                    statusElem.classList.remove('text-gray-500');
                    statusElem.classList.add('text-green-600');
                }
                const imgElem = uploadItemDiv.querySelector('img');
                if (imgElem) {
                    imgElem.src = downloadURL;
                    imgElem.alt = fileNameWithoutExt;
                }
                setTimeout(() => {
                    if (uploadItemDiv.parentNode) {
                        uploadItemDiv.parentNode.removeChild(uploadItemDiv);
                    }
                }, 3000);
            } catch (error) {
                console.error('Error uploading file:', file.name, error);
                const statusElem = document.getElementById(`${uploadItemId}-status`);
                if (statusElem) {
                    statusElem.textContent = `Upload failed for ${file.name}.`;
                    statusElem.classList.remove('text-gray-500');
                    statusElem.classList.add('text-red-600');
                }
                showMessageBox(`Failed to upload ${file.name}. Please try again.`);
            }
        }
        customFileUploadInput.value = '';
    }

    async function generateProofAndShowModal() {
        const customerName = customerNameInput.value.trim();
        const customerEmail = customerEmailInput.value.trim();
        const customerNotes = customerNotesInput.value.trim();
        if (currentOrder.length === 0) {
            showMessageBox('Your order is empty. Please add some items before confirming.');
            return;
        }
        if (!customerName || !customerEmail) {
            showMessageBox('Please enter your Name and Email to confirm your order.');
            return;
        }
        let proofHtml = ``;
        if (customerNotes) {
            proofHtml += `<p class="text-gray-700 mb-3"><strong>Notes:</strong> ${customerNotes}</p>`;
        }
        proofHtml += `<div class="flex flex-wrap justify-center gap-4">`;
        currentOrder.forEach(item => {
            const quantityDisplay = (item.sku === ENVELOPE_SKU) ? `${item.quantity} (in 1,000s)` : item.quantity;
            const packingDetailsDisplay = item.packing_details ? `<br><span class="text-xs text-gray-500">Packing: ${item.packing_details}</span>` : '';
            proofHtml += `
                <div class="proof-item">
                    <img src="${item.imageUrl}" alt="${item.title}" onerror="this.onerror=null;this.src='https://placehold.co/40x40/CCCCCC/000000?text=No+Image';" class="proof-item-img">
                    <p class="text-xs text-gray-600 mt-1">${item.sku}</p>
                    <div class="proof-item-details">
                        <p class="font-medium text-gray-800">${item.title}</p>
                        <p class="text-sm text-gray-600">Qty: ${quantityDisplay}${packingDetailsDisplay}</p>
                    </div>
                </div>
            `;
        });
        proofHtml += `</div>`;
        proofContent.innerHTML = proofHtml;
        proofModal.classList.remove('hidden');
    }

    function generateAdminOrderTableHtml(orderItems) {
        const escapeText = (str) => {
            if (!str) return '';
            return str.replace(/[&<>"']/g, match => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            })[match]);
        };
        let orderText = 'Order Items:\n\n';
        orderItems.forEach(item => {
            const safeTitle = escapeText(item.title || 'Untitled');
            const safeSku = escapeText(item.sku || 'Unknown SKU');
            const safeImageUrl = item.imageUrl && item.imageUrl.startsWith('http') ? item.imageUrl : 'No Image Available';
            const quantityDisplay = item.sku === ENVELOPE_SKU ? `${item.quantity} (x1000)` : item.quantity;
            const packingDetails = escapeText(item.packing_details || '');
            orderText += `SKU: ${safeSku}\nTitle: ${safeTitle}\nQuantity: ${quantityDisplay}${packingDetails ? `\nPacking: ${packingDetails}` : ''}\nImage: ${safeImageUrl}\n\n`;
        });
        console.log('Generated admin order text:', orderText);
        return orderText;
    }

    function generateTemplateParams(type, orderId = 'N/A') {
        const escapeText = (str) => {
            if (!str) return '';
            return str.replace(/[&<>"']/g, match => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            })[match]);
        };
        const customerName = escapeText(customerNameInput.value.trim());
        const customerEmail = escapeText(customerEmailInput.value.trim());
        const rawNotes = escapeText(customerNotesInput.value.trim());
        const orderDate = escapeText(new Date().toLocaleString());
        const orderDetailsCleaned = currentOrder.map(item => ({
            id: escapeText(item.id || ''),
            title: escapeText(item.title || ''),
            sku: escapeText(item.sku || ''),
            quantity: item.quantity || 0,
            imageUrl: item.imageUrl && item.imageUrl.startsWith('http') ? item.imageUrl : 'https://placehold.co/40x40/CCCCCC/000000?text=No+Image',
            quantity_display: item.sku === ENVELOPE_SKU ? `${item.quantity} (x1000)` : `${item.quantity}`,
            packing_details: escapeText(item.packing_details || '')
        }));
        let totalQuantityNonGlow = 0;
        let totalQuantityGlow = 0;
        let totalQuantityEnvelope = 0;
        currentOrder.forEach(item => {
            if (item.sku === ENVELOPE_SKU) {
                totalQuantityEnvelope += item.quantity;
            } else if (item.title.toLowerCase().includes('glow in the dark') || item.sku.toLowerCase().includes('glow in the dark') || item.sku.toLowerCase().includes('gitd')) {
                totalQuantityGlow += item.quantity;
            } else {
                totalQuantityNonGlow += item.quantity;
            }
        });
        const totals = {
            total_nonglow: new Intl.NumberFormat('en-US').format(totalQuantityNonGlow),
            total_glow: new Intl.NumberFormat('en-US').format(totalQuantityGlow),
            total_envelope: new Intl.NumberFormat('en-US').format(totalQuantityEnvelope * 1000)
        };
        if (type === 'customer') {
            return {
                customer_name: customerName,
                customer_email: customerEmail,
                order_items: orderDetailsCleaned,
                date: orderDate,
                total_nonglow: totals.total_nonglow,
                total_glow: totals.total_glow,
                total_envelope: totals.total_envelope,
                raw_notes: rawNotes
            };
        } else if (type === 'admin') {
            const sortedOrderDetails = [...orderDetailsCleaned].sort((a, b) => {
                const idA = a.id.toLowerCase();
                const idB = b.id.toLowerCase();
                return idA.localeCompare(idB, undefined, { numeric: true, sensitivity: 'base' });
            });
            const orderDetailsText = generateAdminOrderTableHtml(sortedOrderDetails);
            return {
                customer_name: customerName,
                customer_email: customerEmail,
                order_id: escapeText(orderId),
                date: orderDate,
                total_nonglow: totals.total_nonglow,
                total_glow: totals.total_glow,
                total_envelope: totals.total_envelope,
                raw_notes: rawNotes,
                order_details_table_html: orderDetailsText
            };
        }
        return {};
    }

    async function sendEmailWithRetry(serviceId, templateId, params, userId, maxRetries = 3, delayMs = 1000) {
        for (let attempt = 1; attempt <= maxRetries; attempt++) {
            try {
                const response = await emailjs.send(serviceId, templateId, params, userId);
                console.log(`Email sent successfully on attempt ${attempt}:`, templateId);
                return { success: true, response };
            } catch (error) {
                console.error(`Email attempt ${attempt} failed for ${templateId}:`, error);
                if (attempt === maxRetries) {
                    return { success: false, error };
                }
                await new Promise(resolve => setTimeout(resolve, delayMs));
            }
        }
        return { success: false, error: new Error('Max retries reached') };
    }

    async function logEmailFailureToFirestore(orderId, type, error) {
        try {
            await addDoc(collection(db, `artifacts/${appId}/email_errors`), {
                order_id: orderId,
                type: type,
                error: error.message || error.toString(),
                timestamp: serverTimestamp(),
                customer_email: customerEmailInput.value.trim()
            });
            console.log(`Logged ${type} email failure to Firestore for order ${orderId}`);
        } catch (firestoreError) {
            console.error('Failed to log email error to Firestore:', firestoreError);
        }
    }

    async function handleSubmitOrder() {
        const customerName = customerNameInput.value.trim();
        const customerEmail = customerEmailInput.value.trim();
        const customerNotes = customerNotesInput.value.trim();
        if (currentOrder.length === 0) {
            showMessageBox('Your order is empty. Please add some items before submitting.');
            return;
        }
        if (!customerName || !customerEmail) {
            showMessageBox('Please enter your Name and Email to submit the order.');
            return;
        }
        const orderPayloadFirestore = {
            customer_name: customerName,
            customer_email: customerEmail,
            customer_notes: customerNotes,
            order_details: currentOrder.map(item => ({
                id: item.id || '',
                title: item.title || '',
                sku: item.sku || '',
                quantity: item.quantity || 0,
                imageUrl: item.imageUrl || 'https://placehold.co/40x40/CCCCCC/000000?text=No+Image',
                packing_details: item.packing_details || ''
            })),
            timestamp: serverTimestamp()
        };
        approveProofBtn.disabled = true;
        reviseOrderBtn.disabled = true;
        generateProofBtn.disabled = true;
        submitOrderButton.disabled = true;
        submitOrderButton.textContent = 'Submitting...';
        showMessageBox('Submitting your order...');
        try {
            let orderDocRef;
            if (currentUserId) {
                orderDocRef = await addDoc(collection(db, `artifacts/${appId}/users/${currentUserId}/orders`), orderPayloadFirestore);
                console.log('Order saved to Firestore successfully! ID:', orderDocRef.id);
            } else {
                console.warn('User not authenticated, skipping Firestore save.');
            }
            const orderId = orderDocRef ? orderDocRef.id : 'N/A';
            const customerTemplateParams = generateTemplateParams('customer', orderId);
            const adminTemplateParams = generateTemplateParams('admin', orderId);
            console.log('Customer email params:', JSON.stringify(customerTemplateParams, null, 2));
            console.log('Admin email params:', JSON.stringify(adminTemplateParams, null, 2));
            let customerEmailSuccess = false;
            let adminEmailSuccess = false;
            const customerEmailResult = await sendEmailWithRetry(
                EMAILJS_SERVICE_ID,
                EMAILJS_TEMPLATE_ID_CUSTOMER,
                customerTemplateParams,
                EMAILJS_USER_ID
            );
            if (customerEmailResult.success) {
                console.log('Customer email sent successfully!');
                customerEmailSuccess = true;
            } else {
                console.error('Customer email failed:', customerEmailResult.error);
                await logEmailFailureToFirestore(orderId, 'customer', customerEmailResult.error);
                showMessageBox(`Order submitted, but failed to send confirmation email to you: ${customerEmailResult.error.message}`);
            }
            const adminEmailResult = await sendEmailWithRetry(
                EMAILJS_SERVICE_ID,
                EMAILJS_TEMPLATE_ID_ADMIN,
                adminTemplateParams,
                EMAILJS_USER_ID
            );
            if (adminEmailResult.success) {
                console.log('Admin proof email sent successfully!');
                adminEmailSuccess = true;
            } else {
                console.error('Admin email failed:', adminEmailResult.error);
                await logEmailFailureToFirestore(orderId, 'admin', adminEmailResult.error);
                showMessageBox(`Order submitted, but failed to send confirmation to admin: ${adminEmailResult.error.message}`);
            }
            if (customerEmailSuccess && adminEmailSuccess) {
                showMessageBox('Order submitted successfully! You will receive a confirmation email shortly.');
            } else if (customerEmailSuccess) {
                showMessageBox('Order submitted successfully! You will receive a confirmation email shortly, but admin email failed.');
            } else if (adminEmailSuccess) {
                showMessageBox('Order submitted successfully! Confirmation email to you failed, but admin received proof.');
            } else {
                showMessageBox('Order submitted, but both confirmation emails failed to send. Please contact support.');
            }
            currentOrder = [];
            renderOrderList();
            customerNotesInput.value = '';
            proofModal.classList.add('hidden');
            customUploadList.innerHTML = '';
        } catch (error) {
            console.error('Error submitting order:', error);
            showMessageBox(`An error occurred while submitting your order: ${error.message}. Please try again.`);
        } finally {
            approveProofBtn.disabled = false;
            reviseOrderBtn.disabled = false;
            generateProofBtn.disabled = false;
            submitOrderButton.disabled = false;
            submitOrderButton.textContent = 'Submit Order';
        }
    }

    function listenForOrderHistory() {
        if (!currentUserId) {
            console.warn('Cannot listen for order history: User not authenticated.');
            return;
        }
        const ordersCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/orders`);
        const q = query(ordersCollectionRef);
        onSnapshot(q, (snapshot) => {
            const orders = [];
            snapshot.forEach(doc => {
                orders.push({ id: doc.id, ...doc.data() });
            });
            renderOrderHistory(orders);
        }, (error) => {
            console.error('Error listening to order history:', error);
            showMessageBox('Error loading order history. Please try refreshing the page.');
        });
    }

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        attachEventListeners();
        renderOrderList();
        emailjs.init(EMAILJS_USER_ID);
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        storage = getStorage(app);
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                currentUserEmail = user.email;
                const userProfileDocRef = doc(db, `artifacts/${appId}/users_profile`, currentUserId);
                const userProfileSnap = await getDoc(userProfileDocRef);
                if (userProfileSnap.exists()) {
                    currentUserName = userProfileSnap.data().name;
                } else {
                    currentUserName = currentUserEmail;
                    console.warn('User profile not found for UID:', currentUserId);
                }
                currentUserNameSpan.textContent = currentUserName || 'Anonymous User';
                userIdDisplay.classList.remove('hidden');
                mainContainer.style.display = 'flex';
                mainContainer.classList.remove('hidden');
                authOverlay.style.display = 'none';
                authOverlay.classList.add('hidden');
                customerEmailInput.value = currentUserEmail || '';
                customerNameInput.value = currentUserName || '';
                console.log('Firebase authenticated. User ID:', currentUserId, 'Email:', currentUserEmail, 'Name:', currentUserName);
                listenForOrderHistory();
                fetchProductCatalog();
            } else {
                console.log('No Firebase user signed in.');
                currentUserId = null;
                currentUserEmail = null;
                currentUserName = null;
                userIdDisplay.classList.add('hidden');
                mainContainer.style.display = 'none';
                mainContainer.classList.add('hidden');
                authOverlay.style.display = 'flex';
                authOverlay.classList.add('hidden');
                authNameInput.classList.add('hidden');
                authNameInput.style.display = 'none';
                isLoginMode = true;
                authTitle.textContent = 'Login to Access Portal';
                authSubmitButton.textContent = 'Login';
                toggleAuthModeText.textContent = "Don't have an account?";
                toggleAuthMode.textContent = 'Sign Up';
                customerNameInput.value = '';
                customerEmailInput.value = '';
                currentOrder = [];
                renderOrderList();
                orderHistoryListDesktop.innerHTML = '<div class="p-4 text-gray-500 text-center" id="emptyOrderHistoryMessageDesktop">No past orders found.</div>';
                orderHistoryListMobile.innerHTML = '<div class="p-4 text-gray-500 text-center" id="emptyOrderHistoryMessageMobile">No past orders found.</div>';
            }
        });
    });
</script>

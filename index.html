<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Ordering Portal</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for Inter font and general layout */
        body {
            font-family: 'Inter', sans-serif;
            @apply bg-gray-100 flex items-center justify-center min-h-screen p-4;
        }
        .container {
            @apply bg-white shadow-lg rounded-xl p-6 md:p-8 w-full max-w-4xl space-y-6;
        }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        /* Custom scrollbar for order list */
        .order-list-scroll {
            max-height: 400px; /* Adjust as needed */
            overflow-y: auto;
            scrollbar-width: thin; /* Firefox */
            scrollbar-color: #cbd5e0 #edf2f7; /* thumb and track track color */
        }
        .order-list-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .order-list-scroll::-webkit-scrollbar-track {
            background: #edf2f7; /* Light gray track */
            border-radius: 10px;
        }
        .order-list-scroll::-webkit-scrollbar-thumb {
            background-color: #cbd5e0; /* Medium gray thumb */
            border-radius: 10px;
            border: 2px solid #edf2f7;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-bold text-gray-800 text-center mb-6">CG Weekly Order Portal</h1>

        <!-- Message Box -->
        <div id="messageBox" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50">
            <div class="bg-white p-6 rounded-xl shadow-lg max-w-sm w-full text-center space-y-4">
                <p id="messageText" class="text-gray-700 text-lg"></p>
                <button id="closeMessageBox" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-200">OK</button>
            </div>
        </div>

        <!-- Search Section -->
        <div class="mb-6 bg-blue-50 p-4 rounded-lg">
            <label for="partSearch" class="block text-gray-700 text-lg font-semibold mb-2">Search Part by Number/Name:</label>
            <div class="flex flex-col sm:flex-row gap-4">
                <input type="text" id="partSearch" placeholder="(e.g., CG-001, BuzzOff2)"
                       class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm">
                <button id="searchButton"
                        class="px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition duration-200 shadow-md">
                    Search
                </button>
            </div>
            <div id="loadingIndicator" class="hidden text-center mt-4 text-blue-600 font-medium">
                Searching...
            </div>
            <div id="searchResults" class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Search results will be dynamically inserted here -->
            </div>
            <div id="noResults" class="hidden text-center text-gray-500 mt-4">No products found. Please try a different search term.</div>
        </div>

        <!-- Order List Section -->
        <div class="mb-6 bg-green-50 p-4 rounded-lg">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Your Order</h2>
            <div id="orderList" class="order-list-scroll border border-gray-200 rounded-lg divide-y divide-gray-200">
                <div class="p-4 text-gray-500 text-center" id="emptyOrderMessage">No items in your order yet.</div>
                <!-- Order items will be dynamically inserted here -->
            </div>
        </div>

        <!-- Customer Information and Submit Order Section -->
        <div class="bg-purple-50 p-4 rounded-lg">
            <h2 class="2xl font-bold text-gray-800 mb-4">Your Details</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="customerName" class="block text-gray-700 font-semibold mb-2">Your Name:</label>
                    <input type="text" id="customerName" placeholder="John Doe"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 shadow-sm">
                </div>
                <div>
                    <label for="customerEmail" class="block text-gray-700 font-semibold mb-2">Your Email:</label>
                    <input type="email" id="customerEmail" placeholder="john.doe@example.com"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 shadow-sm">
                </div>
            </div>
            <div class="mb-6">
                <label for="customerNotes" class="block text-gray-700 font-semibold mb-2">Notes (Optional):</label>
                <textarea id="customerNotes" rows="4" placeholder="Any special instructions or details for this order..."
                          class="w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 shadow-sm"></textarea>
            </div>

            <button id="submitOrder"
                    class="w-full px-6 py-4 bg-purple-600 text-white rounded-lg font-bold text-xl hover:bg-purple-700 transition duration-200 shadow-lg">
                Submit Order
            </button>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        // Shopify Storefront API is not used for product search in this version.
        const SHOPIFY_STORE_DOMAIN = 'dynamic.graphics'; 
        const SHOPIFY_STOREFRONT_ACCESS_TOKEN = 'DUMMY_TOKEN_NOT_USED'; 

        // --- GOOGLE CLOUD FUNCTION ENDPOINT ---
        const GOOGLE_CLOUD_FUNCTION_URL = 'https://send-order-email-932630472953.us-central1.run.app'; 

        // --- GOOGLE SHEET CSV URL FOR PRODUCT CATALOG ---
        // This is the published CSV URL from your Google Sheet with part data.
        const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRJeafxZBqtfXhW91V849PmPbr1C0ExZmnvfQ_410tdo4PPDvXNPHC44VrBEd3G7nRpPulT-XC6R79X/pub?gid=1341072506&single=true&output=csv';

        // --- GLOBAL VARIABLES & CACHED ELEMENTS ---
        let currentOrder = []; // Stores items added to the order
        let productCatalog = []; // Will store the product data fetched from the Google Sheet

        const searchInput = document.getElementById('partSearch');
        const searchButton = document.getElementById('searchButton');
        const searchResultsDiv = document.getElementById('searchResults');
        const noResultsDiv = document.getElementById('noResults');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const orderListDiv = document.getElementById('orderList');
        const emptyOrderMessage = document.getElementById('emptyOrderMessage');
        const customerNameInput = document.getElementById('customerName');
        const customerEmailInput = document.getElementById('customerEmail');
        const customerNotesInput = document.getElementById('customerNotes');
        const submitOrderButton = document.getElementById('submitOrder');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const closeMessageBoxButton = document.getElementById('closeMessageBox');

        // --- UTILITY FUNCTIONS ---

        /**
         * Parses CSV text into an array of objects, robustly handling commas within fields.
         * Assumes the first row is the header.
         * @param {string} csvText The CSV data as a string.
         * @returns {Array<object>} An array of objects, where each object represents a row.
         */
        function parseCSV(csvText) {
            const lines = csvText.trim().split(/\r?\n/); // Split by new line, handling both \n and \r\n
            if (lines.length === 0) return [];

            // Regex to split by comma, ignoring commas within double quotes
            const csvSplitRegex = /,(?=(?:(?:[^"]*"){2})*[^"]*$)/;

            const headers = lines[0].split(csvSplitRegex).map(header => header.trim().replace(/^"|"$/g, '')); // Remove quotes from headers
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line === '') continue; // Skip empty lines

                const values = line.split(csvSplitRegex).map(value => value.trim().replace(/^"|"$/g, '')); // Remove quotes from values

                if (values.length !== headers.length) {
                    console.warn(`Skipping row ${i + 1} due to column mismatch. Expected ${headers.length} columns, got ${values.length}. Row: "${line}"`);
                    continue;
                }
                const rowObject = {};
                headers.forEach((header, index) => {
                    // Special handling for searchTerms: convert to array
                    // Now splits by comma, assuming searchTerms in CSV are comma-separated
                    if (header === 'searchTerms') {
                        rowObject[header] = values[index].split(',').map(term => term.trim().toLowerCase()).filter(term => term !== ''); 
                    } else {
                        rowObject[header] = values[index];
                    }
                });
                data.push(rowObject);
            }
            return data;
        }


        /**
         * Fetches product data from the Google Sheet CSV URL.
         */
        async function fetchProductCatalog() {
            try {
                loadingIndicator.textContent = 'Loading product catalog...';
                loadingIndicator.classList.remove('hidden');

                const response = await fetch(GOOGLE_SHEET_CSV_URL);
                if (!response.ok) {
                    throw new Error(`Failed to fetch product catalog: ${response.statusText}`);
                }
                const csvText = await response.text();
                productCatalog = parseCSV(csvText);
                console.log('Product catalog loaded:', productCatalog);
                loadingIndicator.classList.add('hidden');
            } catch (error) {
                console.error('Error fetching or parsing product catalog:', error);
                loadingIndicator.classList.add('hidden');
                showMessageBox('Error loading product catalog. Please try refreshing the page or contact support.');
            }
        }

        /**
         * Displays a custom message box to the user.
         * @param {string} message The message to display.
         */
        function showMessageBox(message) {
            messageText.textContent = message;
            messageBox.classList.remove('hidden');
        }

        /**
         * Hides the custom message box.
         */
        function hideMessageBox() {
            messageBox.classList.add('hidden');
        }

        /**
         * Renders a single product search result item.
         * @param {object} product The product object from our local catalog.
         * @returns {string} HTML string for the product card.
         */
        function renderProductCard(product) {
            // Using product.id as the unique identifier for the HTML elements
            const uniqueId = product.id.replace(/[^a-zA-Z0-9-_]/g, ''); // Sanitize for HTML ID

            return `
                <div class="flex flex-col sm:flex-row items-center bg-gray-50 border border-gray-200 rounded-lg p-4 shadow-sm">
                    <img src="${product.imageUrl}" alt="${product.title}" class="w-24 h-24 object-contain rounded-lg mr-4 mb-4 sm:mb-0 flex-shrink-0" onerror="this.onerror=null;this.src='https://placehold.co/100x100/CCCCCC/000000?text=No+Image';">
                    <div class="flex-grow text-center sm:text-left min-w-0">
                        <h3 class="font-bold text-gray-800 break-words w-full">${product.title}</h3>
                        <p class="text-sm text-gray-600">SKU: ${product.sku}</p>
                    </div>
                    <div class="flex items-center mt-4 sm:mt-0 flex-shrink-0">
                        <input type="number" value="100" min="1"
                               class="w-20 p-2 border border-gray-300 rounded-l-lg text-center quantity-input"
                               id="qty-${uniqueId}"
                               data-product-id="${product.id}"
                               data-product-title="${product.title}"
                               data-product-sku="${product.sku}"
                               data-product-image="${product.imageUrl}">
                        <button class="px-4 py-2 bg-blue-500 text-white rounded-r-lg hover:bg-blue-600 transition duration-200 add-to-order-btn"
                                data-product-id="${product.id}">
                            Add
                        </button>
                    </div>
                </div>
            `;
        }

        /**
         * Renders the current order list.
         */
        function renderOrderList() {
            orderListDiv.innerHTML = ''; // Clear existing list
            if (currentOrder.length === 0) {
                emptyOrderMessage.classList.remove('hidden');
                orderListDiv.appendChild(emptyOrderMessage);
            } else {
                emptyOrderMessage.classList.add('hidden');
                currentOrder.forEach(item => {
                    const orderItemHtml = `
                        <div class="flex items-center justify-between p-4 bg-white hover:bg-gray-50 transition duration-150">
                            <div class="flex items-center">
                                <img src="${item.imageUrl}" alt="${item.title}" class="w-16 h-16 object-contain rounded-lg mr-4" onerror="this.onerror=null;this.src='https://placehold.co/64x64/CCCCCC/000000?text=No+Image';">
                                <div class="min-w-0">
                                    <h4 class="font-semibold text-gray-800 break-words w-full">${item.title}</h4>
                                    <p class="text-sm text-gray-600">SKU: ${item.sku} - Qty: ${item.quantity}</p>
                                </div>
                            </div>
                            <button class="px-3 py-1 bg-red-500 text-white rounded-lg hover:bg-red-600 transition duration-200 remove-from-order-btn"
                                    data-product-id="${item.id}">
                                Remove
                            </button>
                        </div>
                    `;
                    orderListDiv.insertAdjacentHTML('beforeend', orderItemHtml);
                });
            }
            attachOrderListEventListeners();
        }

        /**
         * Attaches event listeners for add/remove buttons in search results and order list.
         */
        function attachEventListeners() {
            searchButton.addEventListener('click', handleSearch);
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleSearch();
                }
            });
            submitOrderButton.addEventListener('click', handleSubmitOrder);
            closeMessageBoxButton.addEventListener('click', hideMessageBox);
        }

        /**
         * Attaches event listeners specifically for the dynamically rendered order list buttons.
         */
        function attachOrderListEventListeners() {
            document.querySelectorAll('.remove-from-order-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const productId = e.target.dataset.productId;
                    currentOrder = currentOrder.filter(item => item.id !== productId);
                    renderOrderList();
                });
            });
        }

        // --- EVENT HANDLERS ---

        /**
         * Handles the product search logic. Now searches the local productCatalog array.
         */
        async function handleSearch() {
            const searchTerm = searchInput.value.trim().toLowerCase();
            searchResultsDiv.innerHTML = ''; // Clear previous results
            noResultsDiv.classList.add('hidden');
            loadingIndicator.textContent = 'Searching...'; // Reset text
            loadingIndicator.classList.remove('hidden');

            if (!searchTerm) {
                loadingIndicator.classList.add('hidden');
                showMessageBox('Please enter a part number, name, or barcode to search.');
                return;
            }

            // Simulate API call delay for user experience, but actual data is local after fetch
            await new Promise(resolve => setTimeout(resolve, 300)); 

            // Filter the productCatalog fetched from Google Sheet
            const filteredProducts = productCatalog.filter(product => 
                (product.searchTerms && product.searchTerms.some(term => term.includes(searchTerm))) || // searchTerms is already lowercased
                (product.title && product.title.toLowerCase().includes(searchTerm)) ||
                (product.sku && product.sku.toLowerCase().includes(searchTerm))
            );

            loadingIndicator.classList.add('hidden');

            if (filteredProducts.length > 0) {
                filteredProducts.forEach(product => {
                    searchResultsDiv.insertAdjacentHTML('beforeend', renderProductCard(product));
                });
                // Attach event listeners to newly rendered 'Add' buttons
                document.querySelectorAll('.add-to-order-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const productId = e.target.dataset.productId;
                        const productToAdd = productCatalog.find(p => p.id === productId); // Find the full product object

                        if (!productToAdd) {
                            console.error('Product not found in catalog:', productId);
                            showMessageBox('Error: Product not found in catalog. Please try searching again.');
                            return;
                        }

                        // Use the ID generated for the input to find the quantity input
                        // Re-sanitizing productId for lookup, though it should already be clean from renderProductCard
                        const uniqueInputId = `qty-${productId.replace(/[^a-zA-Z0-9-_]/g, '')}`; 
                        const quantityInput = document.getElementById(uniqueInputId); 
                        
                        const quantity = parseInt(quantityInput.value, 10);

                        if (isNaN(quantity) || quantity <= 0) {
                            showMessageBox('Please enter a valid quantity (1 or more).');
                            return;
                        }

                        const existingItemIndex = currentOrder.findIndex(item => item.id === productId);

                        if (existingItemIndex > -1) {
                            currentOrder[existingItemIndex].quantity += quantity;
                        } else {
                            currentOrder.push({
                                id: productToAdd.id,
                                title: productToAdd.title,
                                sku: productToAdd.sku,
                                imageUrl: productToAdd.imageUrl,
                                quantity: quantity
                            });
                        }
                        renderOrderList();
                        // Removed the annoying popup when adding an item: showMessageBox(`${quantity} x ${productToAdd.title} added to order!`);
                    });
                });
            } else {
                noResultsDiv.classList.remove('hidden');
            }
        }

        /**
         * Handles the order submission. Sends order data to a Google Cloud Function.
         */
        async function handleSubmitOrder() {
            const customerName = customerNameInput.value.trim();
            const customerEmail = customerEmailInput.value.trim();
            const customerNotes = customerNotesInput.value.trim();

            if (currentOrder.length === 0) {
                showMessageBox('Your order is empty. Please add some items before submitting.');
                return;
            }

            if (!customerName || !customerEmail) {
                showMessageBox('Please enter your Name and Email to submit the order.');
                return;
            }

            // Prepare payload for the Google Cloud Function
            const orderPayload = {
                customer_name: customerName,
                customer_email: customerEmail,
                customer_notes: customerNotes,
                order_details: currentOrder.map(item => ({
                    id: item.id,
                    title: item.title,
                    sku: item.sku,
                    quantity: item.quantity,
                    imageUrl: item.imageUrl
                }))
            };

            submitOrderButton.textContent = 'Submitting...';
            submitOrderButton.disabled = true;

            try {
                const response = await fetch(GOOGLE_CLOUD_FUNCTION_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(orderPayload),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Cloud Function Error:', errorData);
                    throw new Error(`Cloud Function responded with status ${response.status}: ${errorData.message || 'Unknown error'}`);
                }

                showMessageBox('Order submitted successfully! You will receive a confirmation email shortly.');
                // Clear the form and order
                currentOrder = [];
                renderOrderList();
                searchInput.value = '';
                searchResultsDiv.innerHTML = '';
                customerNameInput.value = '';
                customerEmailInput.value = '';
                customerNotesInput.value = '';
            } catch (error) {
                console.error('Failed to submit order:', error);
                showMessageBox('Failed to submit order. Please try again or contact support.');
            } finally {
                submitOrderButton.textContent = 'Submit Order';
                submitOrderButton.disabled = false;
            }
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            attachEventListeners();
            renderOrderList(); // Render empty order list on load
            fetchProductCatalog(); // Fetch products from Google Sheet on page load
        });
    </script>
</body>
</html>

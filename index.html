<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CG Weekly Ordering Portal</title>
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚙️</text></svg>">
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Ensure box-sizing is border-box for all elements to prevent layout issues */
        *, *::before, *::after {
            box-sizing: border-box;
        }

        /* Custom styles for Inter font and general layout */
        body {
            font-family: 'Inter', sans-serif;
            /* Adjusted padding-right to ensure space for the fixed floating button on the right */
            @apply bg-gray-100 flex items-center justify-center min-h-screen p-4 pr-[90px] overflow-x-hidden; 
        }
        .container {
            /* Removed max-w-7xl to allow full width on small screens */
            /* Added overflow-x-hidden to the container as well */
            @apply bg-white shadow-lg rounded-xl p-4 sm:p-6 w-full mx-auto flex flex-col md:flex-row gap-6 justify-between overflow-x-hidden;
        }
        /* Applied space-y-6 directly to column divs */
        .column-content {
            @apply space-y-6;
        }

        input[type="number"]::-webkit-inner-spian-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        /* Custom scrollbar for order list */
        .order-list-scroll {
            max-height: 400px; /* Adjust as needed */
            overflow-y: auto;
            scrollbar-width: thin; /* Firefox */
            scrollbar-color: #cbd5e0 #edf2f7; /* thumb and track track color */
        }
        .order-list-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .order-list-scroll::-webkit-scrollbar-track {
            background: #edf2f7; /* Light gray track */
            border-radius: 10px;
        }
        .order-list-scroll::-webkit-scrollbar-thumb {
            background-color: #cbd5e0; /* Medium gray thumb */
            border-radius: 10px;
            border: 2px solid #edf2f7;
        }

        /* Styles for authentication overlay/modal */
        #authOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex; /* Always start as flex for the overlay */
            justify-content: center;
            align-items: center;
            z-index: 100;
            flex-direction: column;
        }
        /* The .hidden class will be added/removed by JS, but if present, it overrides display */
        #authOverlay.hidden {
            display: none !important; /* Use !important to ensure it overrides inline styles if needed */
        }

        .auth-prompt {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 400px;
        }
        .auth-prompt input {
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 5px;
            width: 100%;
            display: block;
        }
        .auth-prompt button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 15px;
        }
        .auth-prompt button:hover {
            background-color: #45a049;
        }
        .auth-prompt p {
            color: red;
            margin-top: 10px;
        }
        /* Style for the total quantity numbers in the summary */
        .total-quantity-portal {
            font-size: 1.125rem; /* text-lg */
            font-weight: 700;    /* font-bold */
            color: #333333;
        }
        /* Style for order history item card */
        .order-history-card {
            background-color: white;
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
            margin-bottom: 1rem; /* mb-4 for spacing between cards */
            overflow: hidden; /* Ensures child border-radius applies correctly */
            border: 1px solid #e2e8f0; /* subtle border */
        }

        /* Style for the clickable header button */
        .order-history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%; /* Take full width of its parent card */
            text-align: left;
            padding: 0.75rem 1rem; /* py-3 px-4 */
            background-color: #2563eb; /* bg-blue-600 */
            color: white; /* text-white */
            font-weight: 600; /* font-semibold */
            cursor: pointer;
            border: none; /* Remove default button border */
            transition: background-color 0.2s ease-in-out;
        }
        .order-history-header:hover {
            background-color: #1d4ed8; /* hover:bg-blue-700 */
        }
        .order-history-header h4 {
            color: white; /* Ensure text color is white for the button */
            margin: 0; /* Remove default margin from h4 */
        }
        .order-history-header .toggle-details-btn {
            color: white; /* Ensure text color is white for the span */
            text-decoration: underline; /* Keep underline for visual cue */
            font-size: 0.875rem; /* text-sm */
        }

        /* Style for the expandable details section */
        .order-history-details {
            padding: 1rem; /* Uniform padding */
            border-top: 1px solid #e2e8f0; /* Separator from the button */
            background-color: #f8fafc; /* bg-gray-50 */
        }
        .reorder-btn {
            /* Enhanced styling for re-order button */
            display: inline-block; /* Ensure it behaves like a button */
            padding: 10px 20px; /* px-5 py-2 */
            background-color: #8b5cf6; /* bg-purple-600 */
            color: white; /* text-white */
            border-radius: 8px; /* rounded-lg */
            font-weight: 600; /* font-semibold */
            transition: background-color 0.2s ease-in-out; /* transition duration-200 */
            font-size: 0.875rem; /* text-sm */
            margin-top: 12px; /* mt-3 */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
            border: none; /* Ensure no default button border */
            cursor: pointer;
        }
        .reorder-btn:hover {
            background-color: #7c3aed; /* hover:bg-purple-700 */
        }

        /* Styles for the new floating Order History button */
        #floatingOrderHistoryBtn {
            position: fixed;
            right: 0; /* Position on the right edge */
            top: 50%; /* Vertically center */
            transform: translateY(-50%); /* Adjust for perfect vertical centering */
            z-index: 1000; /* Very high z-index */
            /* Updated styling for a more prominent, rounded vertical tab look on the right */
            background-image: linear-gradient(to bottom, #4f46e5, #2563eb); /* Vertical gradient */
            /* Changed rounded-r-none to rounded-r-full for full rounding on the right edge */
            @apply text-white py-8 px-6 rounded-l-full rounded-r-full shadow-xl font-extrabold text-lg hover:opacity-90 transition duration-200 flex flex-col items-center justify-center gap-2 border-y-4 border-l-4 border-blue-300;
            width: auto; /* Allow width to adjust to content */
            min-height: 150px; /* Ensure a minimum height for the vertical tab */
            /* Stronger shadow on the left */
            box-shadow: -10px 0 20px rgba(0, 0, 0, 0.4), -5px 0 10px rgba(0, 0, 0, 0.3); 
            writing-mode: vertical-lr; /* Makes text vertical from bottom to top, then left to right */
            text-align: center; /* Center text within its vertical space */
            white-space: nowrap; /* Prevent text from wrapping */
            text-transform: none; /* Remove uppercase */
            color: white !important; /* Ensure text color is white */
            font-weight: 900 !important; /* Ensure font is extra bold */
        }
        /* Adjust the icon size and margin for vertical layout */
        #floatingOrderHistoryBtn svg {
            margin-bottom: 8px; /* Space between icon and text */
            margin-right: 0; /* Remove horizontal margin */
            height: 24px; /* Ensure icon size is consistent */
            width: 24px;
        }


        /* Styles for the new full-screen order history modal */
        #orderHistoryModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9); /* Darker overlay */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001; /* Higher than floating button */
            flex-direction: column;
            padding: 1rem; /* Padding for content inside modal */
        }
        #orderHistoryModal.hidden {
            display: none !important;
        }
        #orderHistoryModalContent {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.75rem; /* rounded-xl */
            width: 100%;
            max-width: 600px; /* Max width for readability */
            max-height: 90vh; /* Limit height to prevent overflow on very small screens */
            overflow-y: auto; /* Enable scrolling within the modal content */
            position: relative; /* For positioning close button */
            @apply shadow-2xl;
        }
        #orderHistoryModalCloseBtn {
            position: absolute;
            top: 10px;
            right: 10px;
            @apply bg-red-500 text-white rounded-full h-8 w-8 flex items-center justify-center text-xl font-bold hover:bg-red-600 transition duration-200;
        }

        /* Styles for the new Proof Modal */
        #proofModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9); /* Darker overlay */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1002; /* Higher than other modals */
            flex-direction: column;
            padding: 1rem;
        }
        #proofModal.hidden {
            display: none !important;
        }
        #proofModalContent {
            background-color: white; /* Changed to white background */
            padding: 1.5rem;
            border-radius: 0.75rem; /* rounded-xl */
            width: 100%;
            max-width: 600px; /* Max width for readability */
            max-height: 90vh; /* Limit height to prevent overflow on very small screens */
            overflow-y: auto; /* Enable scrolling within the modal content */
            position: relative;
            @apply shadow-2xl;
        }
        #closeProofModal {
            position: absolute;
            top: 10px;
            right: 10px;
            @apply bg-gray-300 text-gray-700 rounded-full h-8 w-8 flex items-center justify-center text-xl font-bold hover:bg-gray-400 transition duration-200;
        }
        /* Proof item styling */
        #proofContent img.proof-item-img { /* Specific class for proof images */
            max-width: 50px; /* Smaller image */
            max-height: 50px;
            object-fit: contain;
            border-radius: 0.25rem;
            border: 1px solid #e2e8f0; /* Subtle border for images */
            box-shadow: 0 1px 2px rgba(0,0,0,0.1); /* Small shadow for images */
            margin-bottom: 0.25rem; /* Reduced space below image */
        }
        /* Updated #proofContent to be a flex container for array layout */
        #proofContent {
            display: flex;
            flex-wrap: wrap; /* Allow items to wrap to the next line */
            justify-content: center; /* Center items horizontally */
            gap: 1rem; /* Space between items */
            text-align: left; /* Reset text alignment for individual items */
            max-height: 96vh; /* Ensure it doesn't overflow the screen */
            overflow-y: auto; /* Enable scrolling within the modal content */
            padding: 0.5rem; /* Reduced padding */
            border-radius: 0.375rem; /* rounded-md */
            background-color: #ffffff; /* bg-white */
            border: 1px solid #e2e8f0; /* border */
        }

        #proofContent .proof-item {
            /* Each item will be a flex column, centered, with a defined max-width */
            display: flex;
            flex-direction: column; 
            align-items: center; /* Center content within each item */
            max-width: 160px; /* Fixed width for each card */
            width: 100%; /* Ensure it takes full width up to max-width */
            margin-bottom: 0; /* Remove margin-bottom as gap will handle spacing */
            padding: 0.75rem; /* Padding inside each card */
            border: 1px solid #e2e8f0; /* Add border to each card */
            border-radius: 0.5rem; /* Rounded corners for cards */
            background-color: #f8fafc; /* Light background for cards */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* subtle shadow */
            text-align: center; /* Center text within the item */
        }
        #proofContent .proof-item:last-child {
            border-bottom: 1px solid #e2e8f0; /* Ensure last item also has a bottom border if it's a card */
        }
        #proofContent .proof-item-details {
            margin-left: 0; /* Remove horizontal margin for stacked layout */
            margin-top: 0.5rem; /* Space between image and details */
        }
        #proofContent .proof-item-details p {
            margin-bottom: 0.125rem; /* Smaller spacing for text lines */
            font-size: 0.875rem; /* text-sm */
        }
        #proofContent .proof-item-details p:last-child {
            margin-bottom: 0;
        }
    </style>
</head>
<body>
    <!-- Authentication Overlay -->
    <div id="authOverlay" class="hidden">
        <div class="auth-prompt">
            <h2 id="authTitle" class="text-2xl font-bold mb-4">Login to Access Portal</h2>
            <!-- Name input, hidden by default for login, shown for signup -->
            <input type="text" id="authName" placeholder="Your Name" class="hidden" autocomplete="name">
            <input type="email" id="authEmail" placeholder="Email" autocomplete="email">
            <input type="password" id="authPassword" placeholder="Password" autocomplete="current-password">
            <button id="authSubmit">Login</button>
            <p id="authError" class="hidden text-sm"></p>
            <p class="mt-4 text-gray-600">
                <span id="toggleAuthModeText">Don't have an account?</span> 
                <button id="toggleAuthMode" class="text-blue-600 hover:underline font-semibold">Sign Up</button>
            </p>
        </div>
    </div>

    <!-- Main content container - initially hidden -->
    <div class="container hidden">
        <!-- Left Column (Main Content) -->
        <div class="w-full md:flex-grow flex-shrink-0 column-content">
            <h1 class="text-3xl font-bold text-gray-800 text-center mb-6">CG Weekly Order Portal</h1>

            <!-- User ID Display -->
            <div id="userIdDisplay" class="text-sm text-gray-600 text-center mb-4 hidden">
                Logged in as: <span id="currentUserName" class="font-mono text-xs">Loading...</span>
                <button id="logoutButton" class="ml-2 px-3 py-1 bg-red-500 text-white rounded-lg text-xs hover:bg-red-600 transition duration-200">Logout</button>
            </div>

            <!-- Message Box -->
            <div id="messageBox" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50">
                <div class="bg-white p-6 rounded-xl shadow-lg max-w-sm w-full text-center space-y-4">
                    <p id="messageText" class="text-gray-700 text-lg"></p>
                    <button id="closeMessageBox" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-200">OK</button>
                </div>
            </div>

            <!-- Search Section -->
            <div class="bg-blue-50 p-4 rounded-lg">
                <label for="partSearch" class="block text-gray-700 text-lg font-semibold mb-2">Search Part by Number/Name:</label>
                <div class="flex flex-col sm:flex-row gap-4">
                    <input type="text" id="partSearch" placeholder="(e.g., CG-001, BuzzOff2)"
                           class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm">
                    <button id="searchButton"
                            class="px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition duration-200 shadow-md">
                        Search
                    </button>
                </div>
                <div id="loadingIndicator" class="hidden text-center mt-4 text-blue-600 font-medium">
                    Searching...
                </div>
                <div id="searchResults" class="mt-4 flex flex-wrap justify-center gap-4 overflow-x-hidden">
                    <!-- Added overflow-x-hidden to searchResults -->
                    <!-- Search results will be dynamically inserted here -->
                </div>
                <div id="noResults" class="hidden text-center text-gray-500 mt-4">No products found. Please try a different search term.</div>
            </div>

            <!-- Order List Section -->
            <div class="bg-green-50 p-4 rounded-lg">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Your Current Order</h2>
                <div id="orderList" class="order-list-scroll border border-gray-200 rounded-lg divide-y divide-gray-200">
                    <div class="p-4 text-gray-500 text-center" id="emptyOrderMessage">No items in your order yet.</div>
                    <!-- Order items will be dynamically inserted here -->
                </div>
                
                <!-- Order Totals Summary Section -->
                <div id="orderTotalsSummary" class="bg-white border border-gray-200 rounded-lg p-4 mt-4 hidden">
                    <h3 class="text-xl font-bold text-gray-800 mb-3">Order Totals:</h3>
                    <p class="text-gray-700 mb-1"><strong>Total Quantity (excluding "Glow in the Dark"):</strong> <span id="totalNonGlow" class="total-quantity-portal">0</span></p>
                    <p class="text-gray-700 mb-1"><strong>"Glow in the Dark" Stickers Quantity:</strong> <span id="totalGlow" class="total-quantity-portal">0</span></p>
                    <p class="text-gray-700"><strong>Envelope Quantity (in 1,000s):</strong> <span id="totalEnvelope" class="total-quantity-portal">0</span></p>
                </div>
            </div>

            <!-- Customer Information and Submit Order Section -->
            <div class="bg-purple-50 p-4 rounded-lg">
                <h2 class="2xl font-bold text-gray-800 mb-4">Your Details</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="customerName" class="block text-gray-700 font-semibold mb-2">Your Name:</label>
                        <input type="text" id="customerName" placeholder="John Doe"
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 shadow-sm">
                    </div>
                    <div>
                        <label for="customerEmail" class="block text-gray-700 font-semibold mb-2">Your Email:</label>
                        <input type="email" id="customerEmail" placeholder="john.doe@example.com"
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 shadow-sm" readonly>
                    </div>
                </div>
                <div class="mb-6">
                    <label for="customerNotes" class="block text-gray-700 font-semibold mb-2">Notes (Optional):</label>
                    <textarea id="customerNotes" rows="4" placeholder="Any special instructions or details for this order..."
                              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 shadow-sm"></textarea>
                </div>

                <div class="flex flex-col sm:flex-row justify-center gap-4">
                    <button id="generateProofBtn"
                            class="w-full sm:w-1/2 px-6 py-4 bg-indigo-600 text-white rounded-lg font-bold text-xl hover:bg-indigo-700 transition duration-200 shadow-lg">
                        Confirm Order & Review
                    </button>
                    <button id="submitOrder"
                            class="w-full sm:w-1/2 px-6 py-4 bg-purple-600 text-white rounded-lg font-bold text-xl hover:bg-purple-700 transition duration-200 shadow-lg hidden">
                        Submit Order
                    </button>
                </div>
            </div>
        </div>

        <!-- Right Column (Order History) - Hidden on mobile, block on md and up -->
        <div class="w-full md:max-w-sm flex-shrink-0 column-content hidden lg:block">
            <div class="bg-yellow-50 p-4 rounded-lg">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Your Order History</h2>
                <div id="orderHistoryListDesktop" class="order-list-scroll border border-gray-200 rounded-lg">
                    <div class="p-4 text-gray-500 text-center" id="emptyOrderHistoryMessageDesktop">No past orders found.</div>
                    <!-- Order history items will be dynamically inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Order History Button (Mobile Only) -->
    <button id="floatingOrderHistoryBtn" class="lg:hidden">
        Order History
    </button>

    <!-- Full-Screen Order History Modal (Mobile Only) -->
    <div id="orderHistoryModal" class="hidden">
        <div id="orderHistoryModalContent">
            <button id="orderHistoryModalCloseBtn">X</button>
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Your Order History</h2>
            <div id="orderHistoryListMobile" class="order-list-scroll border border-gray-200 rounded-lg">
                <div class="p-4 text-gray-500 text-center" id="emptyOrderHistoryMessageMobile">No past orders found.</div>
                <!-- Order history items will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <!-- Proof Modal -->
    <div id="proofModal" class="hidden">
        <div id="proofModalContent" class="bg-white p-6 rounded-xl shadow-lg max-w_lg w-full text-center space-y-4 relative">
            <button id="closeProofModal" class="absolute top-2 right-2 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            <h3 class="2xl font-bold mb-4">Confirm Your Order</h3>
            <div id="proofContent">
                <!-- Proof details will be inserted here -->
            </div>
            <div class="mt-4 flex flex-col sm:flex-row justify-center gap-4">
                <button id="approveProofBtn" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition duration-200 w-full sm:w-auto">Confirm & Submit Order</button>
                <button id="reviseOrderBtn" class="px-6 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition duration-200 w-full sm:w-auto">Revise Order</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL FIREBASE VARIABLES (Provided by Canvas Environment) ---
        // The appId is provided by the Canvas environment.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Your web app's Firebase configuration (hardcoded as provided by user)
        const firebaseConfig = {
            apiKey: "AIzaSyBdp15BtxFu-VPkuOdkiX1WyXgAMLrj124",
            authDomain: "cg-portal-backend.firebaseapp.com",
            projectId: "cg-portal-backend",
            storageBucket: "cg-portal-backend.firebase-storage.app",
            messagingSenderId: "543604960285",
            appId: "1:543604960285:web:03b481d610a5eb2fdcaaf4",
        };


        // --- CONFIGURATION ---
        const GOOGLE_CLOUD_FUNCTION_URL = 'https://send-order-email-543604960285.us-central1.run.app'; 
        // This URL should be obtained by "Publish to web" as CSV from your Google Sheet.
        const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRJeafxZBqtfXhW91V849PmPbr1C0ExZmnvfQ_410tdo4PPDvXNPHC44VrBEd3G7nRpPulT-XC6R79X/pub?gid=1341072506&single=true&output=csv';
        const ENVELOPE_SKU = 'CG-SE1';
        const ADMIN_PROOF_EMAIL = 'admin@example.com'; // IMPORTANT: Replace with your actual admin email for receiving proofs

        // --- GLOBAL VARIABLES & CACHED ELEMENTS ---
        let currentOrder = []; // Stores items added to the order
        let productCatalog = []; // Will store the product data fetched from the Google Sheet
        
        const searchInput = document.getElementById('partSearch');
        const searchButton = document.getElementById('searchButton');
        const searchResultsDiv = document.getElementById('searchResults');
        const noResultsDiv = document.getElementById('noResults');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const orderListDiv = document.getElementById('orderList');
        const emptyOrderMessage = document.getElementById('emptyOrderMessage');
        const customerNameInput = document.getElementById('customerName');
        const customerEmailInput = document.getElementById('customerEmail');
        const customerNotesInput = document.getElementById('customerNotes');
        const submitOrderButton = document.getElementById('submitOrder');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText'); 
        const closeMessageBoxButton = document.getElementById('closeMessageBox');

        // Authentication related elements
        const authOverlay = document.getElementById('authOverlay');
        const authTitle = document.getElementById('authTitle');
        const authNameInput = document.getElementById('authName'); // New: Name input
        const authEmailInput = document.getElementById('authEmail');
        const authPasswordInput = document.getElementById('authPassword');
        const authSubmitButton = document.getElementById('authSubmit'); // Corrected this line
        const authError = document.getElementById('authError');
        const toggleAuthMode = document.getElementById('toggleAuthMode');
        const toggleAuthModeText = document.getElementById('toggleAuthModeText');
        const mainContainer = document.querySelector('.container'); // Get the main container

        // Order Totals Summary Elements
        const orderTotalsSummaryDiv = document.getElementById('orderTotalsSummary');
        const totalNonGlowSpan = document.getElementById('totalNonGlow');
        const totalGlowSpan = document.getElementById('totalGlow');
        const totalEnvelopeSpan = document.getElementById('totalEnvelope');

        // Elements for Order History and User ID
        const userIdDisplay = document.getElementById('userIdDisplay');
        const currentUserNameSpan = document.getElementById('currentUserName'); 
        const logoutButton = document.getElementById('logoutButton');
        
        // Updated references for order history lists
        const orderHistoryListDesktop = document.getElementById('orderHistoryListDesktop');
        const emptyOrderHistoryMessageDesktop = document.getElementById('emptyOrderHistoryMessageDesktop');
        const orderHistoryListMobile = document.getElementById('orderHistoryListMobile');
        const emptyOrderHistoryMessageMobile = document.getElementById('emptyOrderHistoryMessageMobile');

        // New elements for mobile order history toggle
        const floatingOrderHistoryBtn = document.getElementById('floatingOrderHistoryBtn');
        const orderHistoryModal = document.getElementById('orderHistoryModal');
        const orderHistoryModalCloseBtn = document.getElementById('orderHistoryModalCloseBtn');

        // New elements for Proofing System
        const generateProofBtn = document.getElementById('generateProofBtn');
        const proofModal = document.getElementById('proofModal');
        const closeProofModal = document.getElementById('closeProofModal');
        const proofContent = document.getElementById('proofContent');
        const approveProofBtn = document.getElementById('approveProofBtn');
        const reviseOrderBtn = document.getElementById('reviseOrderBtn');


        let isLoginMode = true; // State for login/signup toggle

        let app, db, auth; 
        let currentUserId = null; // To store the authenticated user's UID
        let currentUserEmail = null; // To store the authenticated user's email
        let currentUserName = null; // To store the authenticated user's name


        // --- UTILITY FUNCTIONS ---

        /**
         * Parses CSV text into an array of objects, robustly handling commas within fields.
         * Assumes the first row is the header.
         * @param {string} csvText The CSV data as a string.
         * @returns {Array<object>} An array of objects, where each object represents a row.
         */
        function parseCSV(csvText) {
            console.log('Parsing CSV Text (raw):', csvText); // Log the raw CSV text
            const lines = csvText.trim().split(/\r?\n/); // Split by new line, handling both \n and \r\n
            if (lines.length === 0) {
                console.warn('No lines found in CSV text.');
                return [];
            }

            console.log('Raw CSV Header Line:', lines[0]); // Log the exact first line

            // Regex to split by comma, ignoring commas within double quotes
            const csvSplitRegex = /,(?=(?:(?:[^"]*"){2})*[^"]*$)/;

            // Extract headers and trim/remove quotes
            const rawHeaders = lines[0].split(csvSplitRegex);
            console.log('Headers after initial split (raw values):', rawHeaders);

            // Filter out any empty strings from the headers array
            const headers = rawHeaders.map(header => header.trim().replace(/^"|"$/g, '')).filter(header => header !== '');
            console.log('Final Parsed Headers (after trim, quote removal, and empty filter):', headers);

            // Check for empty headers (this check is now more robust due to filtering above)
            if (headers.length === 0) {
                console.error('ERROR: No valid headers found after parsing. Please check your Google Sheet CSV headers.');
                showMessageBox('Error: Product catalog headers are malformed or missing. Please check your Google Sheet CSV headers.');
                return []; // Return empty array if no valid headers
            }

            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line === '') {
                    console.log(`Skipping empty line ${i + 1}.`);
                    continue; // Skip empty lines
                }

                const values = line.split(csvSplitRegex).map(value => value.trim().replace(/^"|"$/g, '')); // Remove quotes from values

                // MODIFIED: If more values than headers, truncate values array to match headers length
                if (values.length > headers.length) {
                    console.warn(`Skipping row ${i + 1} due to column mismatch. Expected ${headers.length} columns, got ${values.length}. Truncating. Row: "${line}"`);
                    values.length = headers.length; // Truncate the array to match the number of headers
                } else if (values.length < headers.length) {
                    // If fewer values than headers, this is still an issue, so skip the row
                    console.warn(`Skipping row ${i + 1} due to column mismatch. Expected ${headers.length} columns, got ${values.length}. Row: "${line}"`);
                    continue;
                }

                const rowObject = {};
                headers.forEach((header, index) => {
                    // Special handling for searchTerms: convert to array
                    // Now splits by comma, assuming searchTerms in CSV are comma-separated
                    if (header === 'searchTerms') {
                        rowObject[header] = values[index].split(',').map(term => term.trim().toLowerCase()).filter(term => term !== ''); 
                    } else {
                        rowObject[header] = values[index];
                    }
                });
                data.push(rowObject);
            }
            console.log('Parsed Data (productCatalog before envelope):', data);
            return data;
        }


        /**
         * Fetches product data from the Google Sheet CSV URL and adds hardcoded envelope.
         */
        async function fetchProductCatalog() {
            try {
                loadingIndicator.textContent = 'Loading product catalog...';
                loadingIndicator.classList.remove('hidden');

                const response = await fetch(GOOGLE_SHEET_CSV_URL);
                if (!response.ok) {
                    throw new Error(`Failed to fetch product catalog: ${response.statusText}`);
                }
                const csvText = await response.text();
                // NEW LOG: Log the raw CSV text received by the fetch call
                console.log('Raw CSV Text received by fetch:', csvText.substring(0, 200) + '...'); // Log first 200 chars to avoid huge console output
                productCatalog = parseCSV(csvText);

                // Add the hardcoded envelope item to the product catalog
                const envelopeItem = {
                    id: 'CG-SE1',
                    title: 'Custom Sticker Envelopes',
                    sku: 'CG-SE1',
                    imageUrl: 'https://storage.googleapis.com/cg-portal-assets/CG-SE1%20White%20Bubble%20Sticker%20Envelope.png', // Ensure this URL is correct and public
                    searchTerms: ['envelope', 'envelopes', 'cg-se1']
                };
                // Check if the envelope item already exists to prevent duplicates on re-fetch
                if (!productCatalog.some(item => item.id === envelopeItem.id)) {
                    productCatalog.push(envelopeItem);
                }
                
                console.log('Final Product Catalog (after adding envelope):', productCatalog); // Log the loaded catalog
                loadingIndicator.classList.add('hidden');
            }
            catch (error) {
                console.error('Error fetching or parsing product catalog:', error);
                loadingIndicator.classList.add('hidden');
                showMessageBox('Error loading product catalog. Please try refreshing the page or contact support.');
            }
        }

        /**
         * Displays a custom message box to the user.
         * @param {string} message The message to display.
         */
        function showMessageBox(message) {
            messageText.textContent = message;
            messageBox.classList.remove('hidden');
        }

        /**
         * Hides the custom message box.
         */
        function hideMessageBox() {
            messageBox.classList.add('hidden');
        }

        /**
         * Renders a single product search result item.
         * @param {object} product The product object from our local catalog.
         * @returns {string} HTML string for the product card.
         */
        function renderProductCard(product) {
            // Ensure product.id exists before sanitizing
            const productId = product.id || `unknown-id-${Math.random().toString(36).substring(7)}`;
            const uniqueId = productId.replace(/[^a-zA-Z0-9-_]/g, ''); // Sanitize for HTML ID

            // Determine initial quantity value based on SKU
            const initialQuantity = (product.sku === ENVELOPE_SKU) ? 1 : 100; // 1 for envelope (represents 1000), 100 for others
            const minQuantity = (product.sku === ENVELOPE_SKU) ? 1 : 1; // Minimum of 1 for both
            const quantityUnit = (product.sku === ENVELOPE_SKU) ? ' (x1000)' : ''; // Add unit for envelope

            return `
                <div class="w-full sm:w-56 lg:w-64 flex flex-col items-center bg-gray-50 border border-gray-200 rounded-lg p-4 shadow-sm text-center">
                    <img src="${product.imageUrl}" alt="${product.title}" class="w-20 h-20 object-contain rounded-lg mb-4 flex-shrink-0" onerror="this.onerror=null;this.src='https://placehold.co/100x100/CCCCCC/000000?text=No+Image';">
                    <div class="flex-grow w-full"> <!-- Use w-full to ensure text takes full width -->
                        <h3 class="font-bold text-gray-800 break-words">${product.title}</h3>
                        <p class="text-sm text-gray-600">SKU: ${product.sku}</p>
                    </div>
                    <div class="flex flex-col items-center mt-4 w-full gap-2"> <!-- Quantity and Add button -->
                        <input type="number" value="${initialQuantity}" min="${minQuantity}"
                               class="w-full p-2 border border-gray-300 rounded-lg text-center quantity-input"
                               id="qty-${uniqueId}"
                               data-product-id="${productId}"
                               data-product-title="${product.title}"
                               data-product-sku="${product.sku}"
                               data-product-image="${product.imageUrl}">
                        <button class="w-full px-3 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition duration-200 add-to-order-btn"
                                data-product-id="${productId}">
                            Add${quantityUnit}
                        </button>
                    </div>
                </div>
            `;
        }

        /**
         * Renders the current order list and updates totals.
         */
        function renderOrderList() {
            orderListDiv.innerHTML = ''; // Clear existing list
            if (currentOrder.length === 0) {
                emptyOrderMessage.classList.remove('hidden');
                orderListDiv.appendChild(emptyOrderMessage);
                orderTotalsSummaryDiv.classList.add('hidden'); // Hide totals if order is empty
            } else {
                emptyOrderMessage.classList.add('hidden');
                currentOrder.forEach(item => {
                    const quantityDisplay = (item.sku === ENVELOPE_SKU) ? `${item.quantity} (in 1,000s)` : item.quantity;
                    const orderItemHtml = `
                        <div class="flex items-center justify-between p-4 bg-white hover:bg-gray-50 transition duration-150">
                            <div class="flex items-center">
                                <img src="${item.imageUrl}" alt="${item.title}" class="w-16 h-16 object-contain rounded-lg mr-4" onerror="this.onerror=null;this.src='https://placehold.co/64x64/CCCCCC/000000?text=No+Image';">
                                <div class="min-w-0">
                                    <h4 class="font-semibold text-gray-800 break-words w-full">${item.title}</h4>
                                    <p class="text-sm text-gray-600">SKU: ${item.sku} - Qty: ${quantityDisplay}</p>
                                </div>
                            </div>
                            <button class="px-3 py-1 bg-red-500 text-white rounded-lg hover:bg-red-600 transition duration-200 remove-from-order-btn"
                                    data-product-id="${item.id}">
                                Remove
                            </button>
                        </div>
                    `;
                    orderListDiv.insertAdjacentHTML('beforeend', orderItemHtml);
                });
                updateOrderTotals(); // Call new function to update totals
                orderTotalsSummaryDiv.classList.remove('hidden'); // Show totals if order has items
            }
            attachOrderListEventListeners();
        }

        /**
         * Calculates and updates the order totals summary.
         */
        function updateOrderTotals() {
            let totalQuantityNonGlow = 0;
            let totalQuantityGlow = 0;
            let totalQuantityEnvelope = 0;

            currentOrder.forEach(item => {
                if (item.sku === ENVELOPE_SKU) {
                    totalQuantityEnvelope += item.quantity;
                } else if (item.title.toLowerCase().includes('glow in the dark') || item.sku.toLowerCase().includes('glow in the dark') || item.sku.toLowerCase().includes('gitd')) {
                    totalQuantityGlow += item.quantity;
                } else {
                    totalQuantityNonGlow += item.quantity;
                }
            });

            totalNonGlowSpan.textContent = new Intl.NumberFormat('en-US').format(totalQuantityNonGlow);
            totalGlowSpan.textContent = new Intl.NumberFormat('en-US').format(totalQuantityGlow);
            totalEnvelopeSpan.textContent = new Intl.NumberFormat('en-US').format(totalQuantityEnvelope * 1000); // Format in 1,000s
        }

        /**
         * Renders the order history list.
         * @param {Array<object>} orders An array of order objects from Firestore.
         */
        function renderOrderHistory(orders) {
            // Render for desktop view
            orderHistoryListDesktop.innerHTML = '';
            if (orders.length === 0) {
                emptyOrderHistoryMessageDesktop.classList.remove('hidden');
                orderHistoryListDesktop.appendChild(emptyOrderHistoryMessageDesktop);
            } else {
                emptyOrderHistoryMessageDesktop.classList.add('hidden');
                orders.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));
                orders.forEach(order => {
                    const orderHtml = createOrderHistoryCardHtml(order);
                    orderHistoryListDesktop.insertAdjacentHTML('beforeend', orderHtml);
                });
            }

            // Render for mobile modal view
            orderHistoryListMobile.innerHTML = '';
            if (orders.length === 0) {
                emptyOrderHistoryMessageMobile.classList.remove('hidden');
                orderHistoryListMobile.appendChild(emptyOrderHistoryMessageMobile);
            } else {
                emptyOrderHistoryMessageMobile.classList.add('hidden');
                orders.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));
                orders.forEach(order => {
                    const orderHtml = createOrderHistoryCardHtml(order);
                    orderHistoryListMobile.insertAdjacentHTML('beforeend', orderHtml);
                });
            }
            attachOrderHistoryEventListeners(orders); // Attach event listeners for history items for both lists
        }

        /**
         * Helper function to create HTML for an order history card.
         * @param {object} order The order object.
         * @returns {string} HTML string.
         */
        function createOrderHistoryCardHtml(order) {
            const orderDate = order.timestamp ? new Date(order.timestamp.toDate()).toLocaleString() : 'N/A';
            return `
                <div class="order-history-card" data-order-id="${order.id}">
                    <button class="order-history-header" data-order-id="${order.id}">
                        <h4 class="font-bold">${orderDate}</h4>
                        <span class="toggle-details-btn" data-order-id="${order.id}">
                            View Details
                        </span>
                    </button>
                    <div id="order-details-${order.id}" class="order-history-details hidden">
                        <p class="text-sm text-gray-600 mb-2">Ordered by: ${order.customer_name} (${order.customer_email})</p>
                        ${order.customer_notes ? `<p class="text-sm text-gray-600 mb-2">Notes: ${order.customer_notes}</p>` : ''}
                        <div class="ml-4">
                            ${order.order_details.map(item => {
                                const quantityDisplay = (item.sku === ENVELOPE_SKU) ? `${item.quantity} (in 1,000s)` : item.quantity;
                                return `
                                    <div class="flex items-center mb-2">
                                        <img src="${item.imageUrl}" alt="${item.title}" class="w-10 h-10 object-contain rounded-md mr-2" onerror="this.onerror=null;this.src='https://placehold.co/40x40/CCCCCC/000000?text=No+Image';">
                                        <p class="text-sm text-gray-700">${item.title} (SKU: ${item.sku}) - Qty: ${quantityDisplay}</p>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        <button class="reorder-btn" data-order-id="${order.id}">Re-order This</button>
                    </div>
                </div>
            `;
        }


        /**
         * Toggles the visibility of order details in history.
         * @param {string} orderId The ID of the order to toggle.
         */
        function toggleOrderDetails(orderId) {
            // Find and toggle details in both desktop and mobile lists
            const detailsDivDesktop = document.querySelector(`#orderHistoryListDesktop #order-details-${orderId}`);
            const detailsDivMobile = document.querySelector(`#orderHistoryListMobile #order-details-${orderId}`);

            if (detailsDivDesktop) {
                detailsDivDesktop.classList.toggle('hidden');
                const toggleButton = document.querySelector(`#orderHistoryListDesktop .order-history-header[data-order-id="${orderId}"] .toggle-details-btn`);
                if (toggleButton) {
                    toggleButton.textContent = detailsDivDesktop.classList.contains('hidden') ? 'View Details' : 'Hide Details';
                }
            }
            if (detailsDivMobile) {
                detailsDivMobile.classList.toggle('hidden');
                const toggleButton = document.querySelector(`#orderHistoryListMobile .order-history-header[data-order-id="${orderId}"] .toggle-details-btn`);
                if (toggleButton) {
                    toggleButton.textContent = detailsDivMobile.classList.contains('hidden') ? 'View Details' : 'Hide Details';
                }
            }
        }

        /**
         * Handles re-ordering a past order.
         * @param {string} orderId The ID of the order to re-order.
         */
        function handleReorder(orderId) {
            const orderToReorder = window.orderHistoryList.find(order => order.id === orderId); // Access from global window.orderHistoryList
            if (orderToReorder) {
                currentOrder = JSON.parse(JSON.stringify(orderToReorder.order_details)); // Deep copy to avoid reference issues
                renderOrderList();
                showMessageBox('Order items from history have been added to your current order!');
                orderHistoryModal.classList.add('hidden'); // Close modal after re-order
            } else {
                showMessageBox('Could not find this order in history to re-order.');
            }
        }

        /**
         * Attaches event listeners for various interactions.
         */
        function attachEventListeners() {
            searchButton.addEventListener('click', handleSearch);
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleSearch();
                }
            });
            
            // Allow clicking anywhere on the message box overlay to dismiss it
            messageBox.addEventListener('click', (e) => {
                // Only dismiss if the click is directly on the overlay, not its content
                if (e.target === messageBox) {
                    hideMessageBox();
                }
            });
            // Still allow the OK button to dismiss it
            closeMessageBoxButton.addEventListener('click', hideMessageBox);

            // Authentication event listeners
            authSubmitButton.addEventListener('click', handleAuthSubmit);
            authNameInput.addEventListener('keypress', (e) => { // New: Name input keypress
                if (e.key === 'Enter') {
                    authEmailInput.focus();
                }
            });
            authEmailInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    authPasswordInput.focus();
                }
            });
            authPasswordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleAuthSubmit();
                }
            });
            toggleAuthMode.addEventListener('click', toggleAuthForm);
            logoutButton.addEventListener('click', handleLogout);

            // New: Floating Order History button and modal
            floatingOrderHistoryBtn.addEventListener('click', () => {
                orderHistoryModal.classList.remove('hidden');
            });
            orderHistoryModalCloseBtn.addEventListener('click', () => {
                orderHistoryModal.classList.add('hidden');
            });
            // Allow clicking outside the modal content to close it
            orderHistoryModal.addEventListener('click', (e) => {
                if (e.target === orderHistoryModal) {
                    orderHistoryModal.classList.add('hidden');
                }
            });

            // Proofing System Event Listeners
            generateProofBtn.addEventListener('click', generateProofAndShowModal);
            closeProofModal.addEventListener('click', () => proofModal.classList.add('hidden'));
            approveProofBtn.addEventListener('click', handleSubmitOrder); // Approve & Submit calls handleSubmitOrder
            reviseOrderBtn.addEventListener('click', () => proofModal.classList.add('hidden')); // Revise just closes the modal
            // Allow clicking outside the modal content to close it
            proofModal.addEventListener('click', (e) => {
                if (e.target === proofModal) {
                    proofModal.classList.add('hidden');
                }
            });
        }

        /**
         * Attaches event listeners specifically for the dynamically rendered order list buttons.
         */
        function attachOrderListEventListeners() {
            document.querySelectorAll('.remove-from-order-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const productId = e.target.dataset.productId;
                    currentOrder = currentOrder.filter(item => item.id !== productId);
                    renderOrderList(); // Re-render and update totals
                });
            });
        }

        /**
         * Attaches event listeners specifically for the dynamically rendered order history items.
         * @param {Array<object>} orders The current list of order history objects.
         */
        function attachOrderHistoryEventListeners(orders) {
            // Store orders globally for re-order functionality
            window.orderHistoryList = orders; 

            // Event listener for the entire header (button) to toggle details
            document.querySelectorAll('.order-history-header').forEach(button => {
                button.addEventListener('click', (e) => {
                    // Ensure the click is not on the reorder button itself, if we add line item reorder later
                    if (!e.target.classList.contains('reorder-btn')) {
                        const orderId = e.currentTarget.dataset.orderId; // Use currentTarget as the listener is on the button
                        toggleOrderDetails(orderId);
                    }
                });
            });

            document.querySelectorAll('.reorder-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const orderId = e.target.dataset.orderId;
                    handleReorder(orderId);
                });
            });
        }

        // --- AUTHENTICATION LOGIC ---

        /**
         * Toggles between login and signup forms.
         */
        function toggleAuthForm() {
            isLoginMode = !isLoginMode;
            authError.classList.add('hidden'); // Clear previous errors
            authNameInput.value = ''; // Clear name input
            authEmailInput.value = '';
            authPasswordInput.value = '';

            if (isLoginMode) {
                authTitle.textContent = 'Login to Access Portal';
                authNameInput.classList.add('hidden'); // Hide name input for login
                authNameInput.style.display = 'none'; // Explicitly hide
                authSubmitButton.textContent = 'Login';
                toggleAuthModeText.textContent = "Don't have an account?";
                toggleAuthMode.textContent = 'Sign Up';
                authEmailInput.autocomplete = 'email';
                authPasswordInput.autocomplete = 'current-password';
            } else {
                authTitle.textContent = 'Sign Up for Portal Access';
                authNameInput.classList.remove('hidden'); // Show name input for signup
                authNameInput.style.display = 'block'; // Explicitly show
                authSubmitButton.textContent = 'Sign Up';
                toggleAuthModeText.textContent = "Already have an account?";
                toggleAuthMode.textContent = 'Login';
                authEmailInput.autocomplete = 'new-password'; // Suggest new password for signup
                authPasswordInput.autocomplete = 'new-password';
            }
        }

        /**
         * Handles login or signup based on the current mode.
         */
        async function handleAuthSubmit() {
            const name = authNameInput.value.trim(); // Get name for signup
            const email = authEmailInput.value.trim();
            const password = authPasswordInput.value.trim();

            if (!email || !password) {
                authError.textContent = 'Please enter both email and password.';
                authError.classList.remove('hidden');
                return;
            }
            if (!isLoginMode && !name) { // Name is required only for signup
                authError.textContent = 'Please enter your name.';
                authError.classList.remove('hidden');
                return;
            }

            authSubmitButton.disabled = true;
            authError.classList.add('hidden');

            try {
                if (isLoginMode) {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    // Save user profile to Firestore
                    await setDoc(doc(db, `artifacts/${appId}/users_profile`, user.uid), {
                        name: name,
                        email: email,
                        createdAt: serverTimestamp()
                    });
                }
                // Rely on onAuthStateChanged to handle UI transition and message boxes
            } catch (error) {
                let errorMessage = 'An unknown error occurred.';
                switch (error.code) {
                    case 'auth/invalid-email':
                        errorMessage = 'Invalid email address format.';
                        break;
                    case 'auth/user-disabled':
                        errorMessage = 'Your account has-been disabled.';
                        break;
                    case 'auth/user-not-found':
                    case 'auth/wrong-password':
                        errorMessage = 'Incorrect email or password.';
                        break;
                    case 'auth/email-already-in-use':
                        errorMessage = 'This email is already registered. Try logging in.';
                        break;
                    case 'auth/weak-password':
                        errorMessage = 'Password is too weak. Please use at least 6 characters.';
                        break;
                    default:
                        console.error('Firebase Auth Error:', error);
                        errorMessage = `Authentication failed: ${error.message}`;
                }
                authError.textContent = errorMessage;
                authError.classList.remove('hidden');
            } finally {
                authSubmitButton.disabled = false;
            }
        }

        /**
         * Handles user logout.
         */
        async function handleLogout() {
            try {
                await signOut(auth);
                showMessageBox('You have been logged out.');
                // onAuthStateChanged will handle UI changes
            } catch (error) {
                console.error('Error logging out:', error);
                showMessageBox('Failed to log out. Please try again.');
            }
        }

        // --- EVENT HANDLERS ---

        /**
         * Handles the product search logic. Now searches the local productCatalog array.
         */
        async function handleSearch() {
            const searchTerm = searchInput.value.trim().toLowerCase();
            searchResultsDiv.innerHTML = ''; // Clear previous results
            noResultsDiv.classList.add('hidden');
            loadingIndicator.textContent = 'Searching...'; // Reset text
            loadingIndicator.classList.remove('hidden');

            if (!searchTerm) {
                loadingIndicator.classList.add('hidden');
                showMessageBox('Please enter a part number, name, or barcode to search.');
                return;
            }

            // Simulate API call delay for user experience, but actual data is local after fetch
            await new Promise(resolve => setTimeout(resolve, 300)); 

            // Filter the productCatalog fetched from Google Sheet
            const filteredProducts = productCatalog.filter(product => 
                (product.searchTerms && Array.isArray(product.searchTerms) && product.searchTerms.some(term => term.includes(searchTerm))) || // Check if searchTerms is an array
                (product.title && typeof product.title === 'string' && product.title.toLowerCase().includes(searchTerm)) || // Check if title is string
                (product.sku && typeof product.sku === 'string' && product.sku.toLowerCase().includes(searchTerm)) // Check if sku is string
            );

            console.log('Filtered Products (after search):', filteredProducts); // Log filtered products

            loadingIndicator.classList.add('hidden');

            if (filteredProducts.length > 0) {
                filteredProducts.forEach(product => {
                    searchResultsDiv.insertAdjacentHTML('beforeend', renderProductCard(product));
                });
                // Attach event listeners to newly rendered 'Add' buttons
                document.querySelectorAll('.add-to-order-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const productId = e.target.dataset.productId;
                        const productToAdd = productCatalog.find(p => p.id === productId); // Find the full product object

                        if (!productToAdd) {
                            console.error('Product not found in catalog:', productId);
                            showMessageBox('Error: Product not found in catalog. Please try searching again.');
                            return;
                        }

                        // Use the ID generated for the input to find the quantity input
                        // Re-sanitizing productId for lookup, though it should already be clean from renderProductCard
                        const uniqueInputId = `qty-${productId.replace(/[^a-zA-Z0-9-_]/g, '')}`; 
                        const quantityInput = document.getElementById(uniqueInputId); 
                        
                        const quantity = parseInt(quantityInput.value, 10);

                        if (isNaN(quantity) || quantity <= 0) {
                            showMessageBox('Please enter a valid quantity (1 or more).');
                            return;
                        }

                        const existingItemIndex = currentOrder.findIndex(item => item.id === productId);

                        if (existingItemIndex > -1) {
                            currentOrder[existingItemIndex].quantity += quantity;
                        } else {
                            // Changed from push() to unshift() to add to the top
                            currentOrder.unshift({ 
                                id: productToAdd.id,
                                title: productToAdd.title || '', // Ensure string
                                sku: productToAdd.sku || '',     // Ensure string
                                imageUrl: productToAdd.imageUrl || 'https://placehold.co/60x60/CCCCCC/000000?text=No+Image', // Ensure string with fallback
                                quantity: quantity || 0          // Ensure number
                            });
                        }
                        renderOrderList(); // Re-render and update totals
                        // Removed the annoying popup when adding an item: showMessageBox(`${quantity} x ${productToAdd.title} added to order!`);
                    });
                });
            } else {
                noResultsDiv.classList.remove('hidden');
            }
        }

        /**
         * Generates the proof content and displays the proof modal.
         */
        function generateProofAndShowModal() {
            const customerName = customerNameInput.value.trim();
            const customerEmail = customerEmailInput.value.trim();
            const customerNotes = customerNotesInput.value.trim();

            if (currentOrder.length === 0) {
                showMessageBox('Your order is empty. Please add some items before confirming.');
                return;
            }

            if (!customerName || !customerEmail) {
                showMessageBox('Please enter your Name and Email to confirm your order.');
                return;
            }

            let proofHtml = ``; // Start with an empty string, no customer info by default

            if (customerNotes) {
                proofHtml += `<p class="text-gray-700 mb-3"><strong>Notes:</strong> ${customerNotes}</p>`;
            }

            // Removed: proofHtml += `<h4 class="text-xl font-semibold mb-2">Order Details:</h4>`;
            // The proofContent div now handles its own flex/wrap, so we just append items
            proofHtml += `<div class="flex flex-wrap justify-center gap-4">`; // Start a new flex container for items
            currentOrder.forEach(item => {
                const quantityDisplay = (item.sku === ENVELOPE_SKU) ? `${item.quantity} (in 1,000s)` : item.quantity;
                proofHtml += `
                    <div class="proof-item">
                        <img src="${item.imageUrl}" alt="${item.title}" onerror="this.onerror=null;this.src='https://placehold.co/50x50/CCCCCC/000000?text=No+Image';" class="proof-item-img">
                        <p class="text-xs text-gray-600 mt-1">${item.sku}</p>
                        <div class="proof-item-details">
                            <p class="font-medium text-gray-800">${item.title}</p>
                            <p class="text-sm text-gray-600">Qty: ${quantityDisplay}</p>
                        </div>
                    </div>
                `;
            });
            proofHtml += `</div>`; // Close the flex container for items

            proofContent.innerHTML = proofHtml;
            proofModal.classList.remove('hidden');
        }

        /**
         * Generates the HTML content for the admin proof email.
         * This HTML is designed to be sent as the body of an email.
         * @param {object} orderPayload The order data.
         * @param {string} orderId The Firestore document ID for the order.
         * @returns {string} HTML string for the admin proof.
         */
        function generateAdminProofHtml(orderPayload, orderId) {
            const customerName = orderPayload.customer_name;
            const customerEmail = orderPayload.customer_email;
            const customerNotes = orderPayload.customer_notes;
            const orderDetails = orderPayload.order_details;
            const orderDate = new Date().toLocaleString(); // Current date for the proof

            let itemsHtml = '';
            orderDetails.forEach(item => {
                const quantityDisplay = (item.sku === ENVELOPE_SKU) ? `${item.quantity} (in 1,000s)` : item.quantity;
                itemsHtml += `
                    <tr style="vertical-align: top;">
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
                            <img src="${item.imageUrl}" alt="${item.title}" style="max-width: 60px; max-height: 60px; object-fit: contain; border-radius: 4px; border: 1px solid #e2e8f0; box-shadow: 0 1px 2px rgba(0,0,0,0.1); display: block; margin: 0 auto;" onerror="this.onerror=null;this.src='https://placehold.co/60x60/CCCCCC/000000?text=No+Image';">
                            <p style="font-size: 0.75em; color: #666; margin-top: 4px;">${item.sku}</p>
                        </td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${item.sku}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${item.title}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${quantityDisplay}</td>
                    </tr>
                `;
            });

            const notesSection = customerNotes ? `
                <div style="margin-bottom: 20px;">
                    <p style="font-weight: bold; color: #333; margin-bottom: 5px;">Notes:</p>
                    <p style="color: #555;">${customerNotes}</p>
                </div>
            ` : '';

            return `
                <div style="font-family: 'Inter', sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; border: 1px solid #ccc; border-radius: 8px; background-color: #ffffff;">
                    <h2 style="color: #333; text-align: center; margin-bottom: 20px;">Order Confirmation</h2>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 20px; font-size: 0.9em; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                        <div>
                            <p style="margin: 0;"><strong>Customer:</strong> ${customerName}</p>
                            <p style="margin: 0;"><strong>Email:</strong> ${customerEmail}</p>
                        </div>
                        <div style="text-align: right;">
                            <p style="margin: 0;"><strong>Order Date:</strong> ${orderDate}</p>
                            <p style="margin: 0;"><strong>Order ID:</strong> ${orderId}</p>
                        </div>
                    </div>
                    ${notesSection}
                    <h3 style="color: #333; margin-top: 30px; margin-bottom: 15px;">Order Items:</h3>
                    <table style="width: 100%; border-collapse: collapse; border: 1px solid #ddd;">
                        <thead>
                            <tr style="background-color: #f2f2f2;">
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: center; width: 100px;">Image</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">SKU</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Item</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: right; width: 80px;">Quantity</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHtml}
                        </tbody>
                    </table>
                    <div style="margin-top: 30px; text-align: center; font-size: 0.8em; color: #777;">
                        <p>This is an automated confirmation generated from the CG Weekly Order Portal. Please review carefully.</p>
                    </div>
                </div>
            `;
        }

        /**
         * Handles the order submission. Sends order data to a Google Cloud Function and saves to Firestore.
         */
        async function handleSubmitOrder() {
            const customerName = customerNameInput.value.trim();
            const customerEmail = customerEmailInput.value.trim(); // This will now be pre-filled from auth
            const customerNotes = customerNotesInput.value.trim();

            if (currentOrder.length === 0) {
                showMessageBox('Your order is empty. Please add some items before submitting.');
                return;
            }

            if (!customerName || !customerEmail) {
                showMessageBox('Please enter your Name and Email to submit the order.');
                return;
            }

            // Prepare payload for the Google Cloud Function (for customer confirmation email)
            const orderPayload = {
                customer_name: customerName,
                customer_email: customerEmail,
                customer_notes: customerNotes,
                order_details: currentOrder.map(item => ({
                    id: item.id || '',
                    title: item.title || '',
                    sku: item.sku || '',
                    quantity: item.quantity || 0,
                    imageUrl: item.imageUrl || 'https://placehold.co/64x64/CCCCCC/000000?text=No+Image'
                }))
            };

            // Disable buttons to prevent multiple submissions
            approveProofBtn.disabled = true;
            reviseOrderBtn.disabled = true;
            generateProofBtn.disabled = true; // Disable generate proof button during submission
            submitOrderButton.disabled = true;
            submitOrderButton.textContent = 'Submitting...'; // Update text for main button

            try {
                // 1. Save order to Firestore FIRST to get the ID
                let orderDocRef;
                if (currentUserId) {
                    const orderToSave = {
                        ...orderPayload,
                        timestamp: serverTimestamp(),
                        userId: currentUserId
                    };
                    orderDocRef = await addDoc(collection(db, `artifacts/${appId}/users/${currentUserId}/orders`), orderToSave);
                    console.log('Order saved to Firestore successfully! ID:', orderDocRef.id);
                } else {
                    console.warn('User not authenticated, skipping Firestore save.');
                }

                const orderId = orderDocRef ? orderDocRef.id : 'N/A'; // Get the generated ID

                // Generate admin proof HTML with the orderId
                const adminProofHtml = generateAdminProofHtml(orderPayload, orderId); // Pass orderId

                // Prepare payload for the admin proof email (sent automatically)
                const adminProofPayload = {
                    customer_name: customerName,
                    customer_email: customerEmail,
                    recipient_email: ADMIN_PROOF_EMAIL, // Send to admin email
                    subject: `New Order Confirmation for ${customerName} (${customerEmail}) - Order ID: ${orderId}`, // Custom subject for admin
                    html_body: adminProofHtml, // Send as HTML body
                    is_proof: true // Optional flag for the cloud function to handle proof formatting
                };

                // Send both emails in parallel (or sequentially if preferred)
                const [customerResponse, adminProofResponse] = await Promise.all([
                    fetch(GOOGLE_CLOUD_FUNCTION_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(orderPayload), // Customer confirmation
                    }),
                    fetch(GOOGLE_CLOUD_FUNCTION_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(adminProofPayload), // Admin proof
                    })
                ]);

                if (!customerResponse.ok) {
                    const errorData = await customerResponse.json(); 
                    const errorMessage = errorData.message || `Server error: ${customerResponse.status} ${customerResponse.statusText}`;
                    console.error('Customer email sending failed (Cloud Function):', errorMessage);
                    showMessageBox(`Failed to send order confirmation: ${errorMessage}`);
                    return; // Stop here if customer email sending fails
                }

                if (!adminProofResponse.ok) {
                    const errorData = await adminProofResponse.json();
                    const errorMessage = errorData.message || `Server error: ${adminProofResponse.status} ${adminProofResponse.statusText}`;
                    console.error('Admin proof email sending failed (Cloud Function):', errorMessage);
                    // Do not block user submission if admin email fails, but log and inform if critical
                    showMessageBox(`Order submitted, but failed to send confirmation to admin: ${errorMessage}`);
                }

                console.log('Order submitted successfully!');
                showMessageBox('Order submitted successfully! You will receive a confirmation email shortly. A confirmation has also been sent to the administrators.');
                currentOrder = []; // Clear the order after successful submission
                renderOrderList(); // Update the UI
                customerNotesInput.value = ''; // Clear notes
                proofModal.classList.add('hidden'); // Hide proof modal on successful submission

            } catch (error) {
                console.error('Error submitting order or saving to Firestore:', error);
                showMessageBox('An error occurred while submitting your order. Please check your internet connection and try again.');
            } finally {
                // Re-enable buttons
                approveProofBtn.disabled = false;
                reviseOrderBtn.disabled = false;
                generateProofBtn.disabled = false; // Re-enable generate proof button
                submitOrderButton.disabled = false;
                submitOrderButton.textContent = 'Submit Order'; // Reset text for main button
            }
        }

        /**
         * Listens for real-time updates to the user's order history from Firestore.
         */
        function listenForOrderHistory() {
            if (!currentUserId) {
                console.warn('Cannot listen for order history: User not authenticated.');
                return;
            }

            const ordersCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/orders`);
            const q = query(ordersCollectionRef); // No orderBy to avoid index issues

            onSnapshot(q, (snapshot) => {
                const orders = [];
                snapshot.forEach(doc => {
                    orders.push({ id: doc.id, ...doc.data() });
                });
                renderOrderHistory(orders);
            }, (error) => {
                console.error('Error listening to order history:', error);
                showMessageBox('Error loading order history. Please try refreshing the page.');
            });
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            attachEventListeners();
            renderOrderList(); // Initial render of an empty order list

            // Initialize Firebase instances using the provided config
            app = initializeApp(firebaseConfig); 
            auth = getAuth(app);
            db = getFirestore(app);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUserId = user.uid; // Assign to global variable
                    currentUserEmail = user.email; // Assign to global variable
                    
                    // Fetch user's name from Firestore
                    const userProfileDocRef = doc(db, `artifacts/${appId}/users_profile`, currentUserId);
                    const userProfileSnap = await getDoc(userProfileDocRef);
                    if (userProfileSnap.exists()) {
                        currentUserName = userProfileSnap.data().name;
                    } else {
                        currentUserName = currentUserEmail; // Fallback to email if name not found
                        console.warn('User profile not found for UID:', currentUserId, 'Falling back to email for display.');
                    }

                    currentUserNameSpan.textContent = currentUserName || 'Anonymous User'; // Display name or 'Anonymous User'
                    userIdDisplay.classList.remove('hidden');
                    
                    // Explicitly manage display property for main content and overlay
                    mainContainer.style.display = 'flex'; // Changed to flex
                    mainContainer.classList.remove('hidden'); // Ensure hidden class is removed
                    
                    authOverlay.style.display = 'none'; // Explicitly hide the overlay
                    authOverlay.classList.add('hidden'); // Ensure hidden class is added

                    // Prefill Email field from auth, make it readonly
                    customerEmailInput.value = currentUserEmail || ''; 
                    // Autofill Name field
                    customerNameInput.value = currentUserName || '';

                    console.log('Firebase authenticated. User ID:', currentUserId, 'Email:', currentUserEmail, 'Name:', currentUserName);
                    listenForOrderHistory(); // Start listening for history
                    fetchProductCatalog(); // Attempt to fetch product catalog from Google Sheet
                } else {
                    console.log('No Firebase user signed in. Showing authentication prompt.');
                    currentUserId = null; // Assign to global variable
                    currentUserEmail = null; // Assign to global variable
                    currentUserName = null; // Clear name on logout
                    userIdDisplay.classList.add('hidden');
                    
                    // Explicitly manage display property for main content and overlay
                    mainContainer.style.display = 'none'; // Hide main content
                    mainContainer.classList.add('hidden'); // Ensure hidden class is added
                    
                    authOverlay.style.display = 'flex'; // Explicitly show the overlay
                    authOverlay.classList.remove('hidden'); // Ensure hidden class is removed
                    
                    // Crucially, ensure name input is hidden when showing login form
                    authNameInput.classList.add('hidden'); 
                    authNameInput.style.display = 'none'; // Explicitly hide here too
                    isLoginMode = true; // Reset to login mode
                    authTitle.textContent = 'Login to Access Portal';
                    authSubmitButton.textContent = 'Login';
                    toggleAuthModeText.textContent = "Don't have an account?";
                    toggleAuthMode.textContent = 'Sign Up';

                    // Clear prefilled fields if logged out
                    customerNameInput.value = '';
                    customerEmailInput.value = '';
                    currentOrder = []; // Clear current order on logout
                    renderOrderList(); // Update current order display
                    // Clear both desktop and mobile history lists
                    orderHistoryListDesktop.innerHTML = '<div class="p-4 text-gray-500 text-center" id="emptyOrderHistoryMessageDesktop">No past orders found.</div>';
                    orderHistoryListMobile.innerHTML = '<div class="p-4 text-gray-500 text-center" id="emptyOrderHistoryMessageMobile">No past orders found.</div>';
                }
            });
        });
    </script>
</body>
</html>
